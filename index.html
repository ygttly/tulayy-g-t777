<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TÃ¼lay & YiÄŸit ğŸ’•</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
<style>
:root {
  --rose: #e8698a;
  --rose-light: #f5b8c8;
  --rose-dark: #c0435f;
  --cream: #fff8f0;
  --gold: #d4a853;
  --text: #3d2b35;
  --text-light: #7a5c68;
  --card: rgba(255,255,255,0.85);
  --shadow: 0 8px 32px rgba(192,67,95,0.13);
  --input-border: var(--rose-light);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Lato', sans-serif;
  background: var(--cream);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
  transition: background 0.3s, color 0.3s;
}


/* EMOJI RAIN */
#emoji-rain {
  position: fixed; top: 0; left: 0; width: 100%; height: 100%;
  pointer-events: none; z-index: 0; overflow: hidden;
}
.emoji-drop {
  position: absolute; top: -60px; font-size: 1.4rem;
  animation: fall linear infinite;
  opacity: 0.55;
  user-select: none;
}
@keyframes fall {
  0% { transform: translateY(-60px) rotate(0deg); opacity: 0.6; }
  100% { transform: translateY(110vh) rotate(360deg); opacity: 0; }
}

/* NAV */
nav {
  position: sticky; top: 0; z-index: 100;
  background: rgba(255,240,245,0.95);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid var(--rose-light);
  padding: 0 10px 0 16px;
  display: grid;
  grid-template-columns: auto 1fr auto;
  align-items: center;
  height: 60px;
  gap: 8px;
}
.nav-logo {
  font-family: 'Playfair Display', serif;
  font-size: 1.3rem; color: var(--rose-dark);
  letter-spacing: 1px;
  white-space: nowrap;
}
.nav-tabs {
  display: flex; gap: 2px; overflow-x: auto; scrollbar-width: none;
  justify-content: center; padding: 0 4px;
  min-width: 0;
}
.nav-tabs::-webkit-scrollbar { display: none; }
.tab-btn {
  border: none; background: none; cursor: pointer;
  font-family: 'Lato', sans-serif; font-size: 0.78rem;
  color: var(--text-light); padding: 8px 10px; border-radius: 20px;
  transition: all 0.2s; white-space: nowrap; font-weight: 600;
}
.tab-btn:hover, .tab-btn.active {
  background: var(--rose); color: white;
}

/* PAGES */
.page { display: none; padding: 20px; max-width: 900px; margin: 0 auto; position: relative; z-index: 1; }
.page.active { display: block; }

/* HOME */
.home-hero {
  text-align: center; padding: 30px 20px;
}
.couple-photos {
  display: flex; justify-content: center; gap: 20px; margin-bottom: 24px; flex-wrap: wrap;
}
.profile-card {
  position: relative; display: flex; flex-direction: column; align-items: center;
}
.profile-photo-wrap {
  position: relative; cursor: pointer;
}
.profile-photo {
  width: 130px; height: 130px; border-radius: 50%;
  object-fit: cover;
  border: 4px solid var(--rose);
  box-shadow: 0 4px 20px rgba(232,105,138,0.3);
  background: linear-gradient(135deg, #f9d4df, #fce8ec);
  display: flex; align-items: center; justify-content: center;
  font-size: 3rem;
}
.profile-photo img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }
.photo-overlay {
  position: absolute; inset: 0; border-radius: 50%;
  background: rgba(232,105,138,0.6);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  opacity: 0; transition: opacity 0.2s;
  font-size: 0.7rem; color: white; font-weight: 700; gap: 4px;
}
.profile-photo-wrap:hover .photo-overlay { opacity: 1; }
.profile-name {
  margin-top: 10px;
  font-family: 'Playfair Display', serif;
  font-size: 1.1rem; color: var(--rose-dark);
}
.heart-divider { font-size: 2.5rem; display: flex; align-items: center; color: var(--rose); }

.couple-title {
  font-family: 'Playfair Display', serif;
  font-size: 2.2rem; color: var(--rose-dark); margin-bottom: 8px;
}
.couple-sub { color: var(--text-light); font-size: 0.95rem; margin-bottom: 28px; }

.stats-grid {
  display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: 14px; margin-bottom: 28px;
}
.stat-card {
  background: var(--card);
  border-radius: 20px; padding: 18px 14px; text-align: center;
  box-shadow: var(--shadow);
  border: 1px solid var(--rose-light);
}
.stat-icon { font-size: 1.8rem; margin-bottom: 6px; }
.stat-label { font-size: 0.73rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
.stat-value { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--rose-dark); }
.stat-value.timer { font-size: 0.95rem; color: var(--text); }

.zodiac-section {
  display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px;
}
.zodiac-card {
  background: linear-gradient(135deg, #fff0f5, #fff8f0);
  border-radius: 20px; padding: 18px; text-align: center;
  box-shadow: var(--shadow); border: 1px solid var(--rose-light);
}
.zodiac-sign { font-size: 2.5rem; }
.zodiac-name { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--rose-dark); margin: 4px 0; }
.zodiac-comment { font-size: 0.8rem; color: var(--text-light); line-height: 1.5; }

.horoscope-section {
  background: linear-gradient(135deg, #fff0f5, #fff8fa);
  border-radius: 20px; padding: 20px; margin-bottom: 20px;
  border: 1px solid var(--rose-light); box-shadow: var(--shadow);
}
.horoscope-title { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--rose-dark); margin-bottom: 12px; text-align: center; }
.horoscope-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.horoscope-person { }
.horoscope-person-name { font-weight: 700; color: var(--rose); font-size: 0.85rem; margin-bottom: 4px; }
.horoscope-text { font-size: 0.82rem; color: var(--text); line-height: 1.6; }
.horoscope-load-btn {
  display: block; width: 100%; margin-top: 12px;
  background: var(--rose); color: white; border: none; border-radius: 12px;
  padding: 10px; cursor: pointer; font-size: 0.85rem; font-family: 'Lato', sans-serif;
  transition: background 0.2s;
}
.horoscope-load-btn:hover { background: var(--rose-dark); }

/* First meeting section */
.meeting-section {
  background: linear-gradient(135deg, #2d1b2e, #4a2545);
  border-radius: 24px; padding: 24px; color: white; margin-top: 20px;
  box-shadow: 0 12px 40px rgba(45,27,46,0.4);
}
.meeting-title { font-family: 'Playfair Display', serif; font-size: 1.3rem; margin-bottom: 16px; text-align: center; color: #f5b8c8; }
.meeting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }
.meeting-info p { font-size: 0.85rem; line-height: 1.8; color: #e8d4dc; }
.meeting-info strong { color: #f5b8c8; }
.weather-moon { display: flex; flex-direction: column; gap: 10px; }
.weather-box, .moon-box {
  background: rgba(255,255,255,0.1); border-radius: 16px; padding: 14px; text-align: center;
}
.weather-icon { font-size: 2.5rem; }
.weather-desc { font-size: 0.8rem; color: #e8d4dc; margin-top: 4px; }
.moon-icon { font-size: 2.5rem; }
.moon-desc { font-size: 0.8rem; color: #e8d4dc; margin-top: 4px; }
.map-btn {
  display: block; width: 100%; margin-top: 14px;
  background: var(--rose); color: white; border: none; border-radius: 12px;
  padding: 11px; cursor: pointer; font-size: 0.85rem; text-decoration: none;
  text-align: center; font-family: 'Lato', sans-serif; font-weight: 600;
  transition: background 0.2s;
}
.map-btn:hover { background: var(--rose-dark); }


/* KISS COUNTER */
.kiss-section {
  background: linear-gradient(135deg, #fff0f5, #ffe8f2);
  border-radius: 24px; padding: 24px; margin-bottom: 20px;
  border: 2px solid var(--rose-light);
  box-shadow: var(--shadow);
  text-align: center;
}
.kiss-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.4rem; color: var(--rose-dark);
  margin-bottom: 4px;
}
.kiss-subtitle {
  font-size: 0.78rem; color: var(--text-light); margin-bottom: 20px;
}
.kiss-buttons {
  display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 14px;
}
.kiss-item { display: flex; flex-direction: column; align-items: center; gap: 10px; }
.kiss-btn {
  display: flex; flex-direction: column; align-items: center; gap: 6px;
  border: none; border-radius: 20px; padding: 18px 24px; cursor: pointer;
  font-family: 'Lato', sans-serif; font-weight: 700;
  transition: transform 0.12s, box-shadow 0.12s;
  box-shadow: 0 4px 18px rgba(232,105,138,0.25);
  position: relative; overflow: hidden;
}
.kiss-btn:active { transform: scale(0.93); }
.kiss-btn-tulay { background: linear-gradient(135deg, #e8698a, #f5a0bb); color: white; }
.kiss-btn-yigit { background: linear-gradient(135deg, #6a9ae8, #a0c4f5); color: white; }
.kiss-emoji { font-size: 2rem; line-height: 1; }
.kiss-name { font-size: 0.85rem; letter-spacing: 0.5px; }
.kiss-count {
  font-family: 'Playfair Display', serif;
  font-size: 2.8rem; font-weight: 700;
  color: var(--rose-dark); line-height: 1;
  transition: transform 0.15s;
}
.kiss-count.bump { transform: scale(1.3); }
.kiss-count-label { font-size: 0.75rem; color: var(--text-light); }
.kiss-reset-note { font-size: 0.72rem; color: var(--text-light); margin-top: 4px; }

/* Flying kiss animation */
@keyframes kiss-fly {
  0%   { opacity: 1; transform: translate(-50%, -50%) scale(0.5); }
  60%  { opacity: 1; transform: translate(calc(-50% + var(--dx)), calc(-50% - 80px)) scale(1.3); }
  100% { opacity: 0; transform: translate(calc(-50% + var(--dx)), calc(-50% - 160px)) scale(0.8); }
}
.kiss-fly-emoji {
  position: fixed; pointer-events: none; z-index: 9999;
  font-size: 1.8rem; animation: kiss-fly 0.9s ease-out forwards;
}

/* ALBUM */
.album-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 10px; }
.album-title { font-family: 'Playfair Display', serif; font-size: 1.5rem; color: var(--rose-dark); }
.add-btn {
  background: var(--rose); color: white; border: none; border-radius: 12px;
  padding: 10px 18px; cursor: pointer; font-family: 'Lato', sans-serif;
  font-size: 0.85rem; font-weight: 600; transition: background 0.2s;
}
.add-btn:hover { background: var(--rose-dark); }
.album-grid {
  display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 14px;
}
.album-item {
  border-radius: 16px; overflow: hidden;
  box-shadow: var(--shadow); position: relative;
  background: var(--card);
  border: 1px solid var(--rose-light);
}
.album-item img { width: 100%; aspect-ratio: 1; object-fit: cover; display: block; }
.album-caption { padding: 8px 10px; font-size: 0.82rem; color: var(--text); }
.album-item-actions {
  position: absolute; top: 6px; right: 6px;
  display: flex; gap: 4px;
}
.album-del-btn {
  background: rgba(255,255,255,0.9); border: none; border-radius: 50%;
  width: 28px; height: 28px; cursor: pointer; font-size: 0.9rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.album-del-btn:hover { background: #ffe0e8; }

/* MEMORIES */
.memories-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.cal-nav { display: flex; align-items: center; gap: 12px; }
.cal-nav-btn {
  background: var(--rose); color: white; border: none; border-radius: 50%;
  width: 34px; height: 34px; cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
}
.cal-month-label { font-family: 'Playfair Display', serif; font-size: 1.1rem; color: var(--rose-dark); }
.calendar-grid {
  background: var(--card); border-radius: 20px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--rose-light);
}
.cal-days-header {
  display: grid; grid-template-columns: repeat(7, 1fr);
  background: var(--rose); color: white;
}
.cal-day-header { padding: 10px 0; text-align: center; font-size: 0.78rem; font-weight: 600; }
.cal-days-body {
  display: grid; grid-template-columns: repeat(7, 1fr);
}
.cal-day {
  min-height: 56px; padding: 6px 4px; text-align: center;
  cursor: pointer; border: 1px solid #c9a0b0; position: relative;
  transition: background 0.15s;
  font-size: 0.88rem;
}
.cal-day:hover { background: #fff0f5; }
.cal-day.other-month { color: #ccc; }
.cal-day.today { background: #fff0f5; font-weight: 700; color: var(--rose); }
.cal-day.has-memory::after {
  content: 'ğŸ’•'; position: absolute; bottom: 2px; right: 2px; font-size: 0.75rem;
}
.cal-day.is-meetup::before {
  content: 'ğŸ¤'; position: absolute; top: 2px; left: 2px; font-size: 0.7rem;
}
.cal-day.start-day { background: linear-gradient(135deg, #ffe8f0, #ffd0e0); }

/* MODAL */
.modal-backdrop {
  position: fixed; inset: 0; background: rgba(61,43,53,0.5); z-index: 200;
  display: none; align-items: center; justify-content: center; padding: 16px;
}
.modal-backdrop.open { display: flex; }
.modal {
  background: var(--cream); border-radius: 24px; padding: 24px; width: 100%; max-width: 480px;
  max-height: 90vh; overflow-y: auto;
  box-shadow: 0 20px 60px rgba(61,43,53,0.3);
  position: relative;
}
.modal-title {
  font-family: 'Playfair Display', serif; font-size: 1.3rem;
  color: var(--rose-dark); margin-bottom: 16px; text-align: center;
}
.modal-close {
  position: absolute; top: 16px; right: 16px;
  background: #f5e6ea; border: none; border-radius: 50%;
  width: 32px; height: 32px; cursor: pointer; font-size: 1rem;
  display: flex; align-items: center; justify-content: center;
}
.modal textarea, .modal input[type=text] {
  width: 100%; border: 1.5px solid var(--rose-light); border-radius: 12px;
  padding: 12px; font-family: 'Lato', sans-serif; font-size: 0.9rem;
  color: var(--text); background:#fff; resize: vertical; margin-bottom: 12px; outline: none;
}
.modal textarea:focus, .modal input:focus { border-color: var(--rose); }
.modal-save-btn {
  width: 100%; background: var(--rose); color: white; border: none;
  border-radius: 14px; padding: 13px; cursor: pointer;
  font-family: 'Lato', sans-serif; font-size: 0.95rem; font-weight: 700;
  transition: background 0.2s;
}
.modal-save-btn:hover { background: var(--rose-dark); }
.check-row { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; }
.check-row input[type=checkbox] { width: 18px; height: 18px; accent-color: var(--rose); cursor: pointer; }
.check-row label { font-size: 0.88rem; color: var(--text); cursor: pointer; }

.memory-preview {
  margin-top: 16px; border-top: 1px solid var(--rose-light); padding-top: 14px;
}
.memory-item {
  background: #fff8fc; border-radius: 12px; padding: 10px 14px;
  margin-bottom: 8px; position: relative;
  border: 1px solid var(--rose-light);
}
.memory-item-text { font-size: 0.85rem; color: var(--text); line-height: 1.6; margin-bottom: 6px; }
.memory-item-img { width: 100%; border-radius: 8px; margin-top: 6px; }
.memory-item-del {
  position: absolute; top: 8px; right: 8px;
  background: #ffe0e8; border: none; border-radius: 8px;
  padding: 3px 8px; font-size: 0.75rem; cursor: pointer; color: var(--rose-dark);
}
.memory-item-img-del {
  background: #ffe0e8; border: none; border-radius: 8px;
  padding: 3px 8px; font-size: 0.75rem; cursor: pointer; color: var(--rose-dark);
  margin-top: 4px; display: inline-block;
}

/* FUTURE */
.section-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: var(--rose-dark); margin-bottom: 16px; }
.dreams-list { list-style: none; margin-bottom: 20px; }
.dream-item {
  background: var(--card); border-radius: 14px; padding: 14px 16px; margin-bottom: 10px;
  border: 1px solid var(--rose-light); box-shadow: var(--shadow);
  display: flex; align-items: flex-start; gap: 10px;
}
.dream-item-text { flex: 1; font-size: 0.88rem; color: var(--text); line-height: 1.6; }
.dream-del { background: none; border: none; cursor: pointer; font-size: 1rem; color: var(--rose); }
.dream-input-row { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
.dream-input-row input {
  flex: 1; border: 1.5px solid var(--rose-light); border-radius: 12px;
  padding: 10px 14px; font-family: 'Lato', sans-serif; font-size: 0.9rem; outline: none; min-width: 150px;
}
.dream-input-row input:focus { border-color: var(--rose); }
.dream-who { display: flex; gap: 6px; }
.who-btn {
  padding: 8px 14px; border-radius: 10px; border: 1.5px solid var(--rose-light);
  background: white; cursor: pointer; font-size: 0.8rem; font-family: 'Lato', sans-serif;
  transition: all 0.2s;
}
.who-btn.active { background: var(--rose); color: white; border-color: var(--rose); }

.letter-section {
  background: linear-gradient(135deg, #fff5f8, #fff0f5);
  border-radius: 20px; padding: 20px; border: 1px solid var(--rose-light); box-shadow: var(--shadow);
}
.letter-subtitle { font-size: 0.85rem; color: var(--text-light); margin-bottom: 14px; }
.letter-tabs { display: flex; gap: 8px; margin-bottom: 14px; }
.letter-tab {
  padding: 8px 16px; border-radius: 10px; border: 1.5px solid var(--rose-light);
  background: white; cursor: pointer; font-size: 0.82rem; font-family: 'Lato', sans-serif;
  transition: all 0.2s;
}
.letter-tab.active { background: var(--rose); color: white; border-color: var(--rose); }
.letter-textarea {
  width: 100%; border: 1.5px solid var(--rose-light); border-radius: 12px;
  padding: 12px; font-family: 'Lato', sans-serif; font-size: 0.88rem;
  color: var(--text); resize: vertical; min-height: 100px; outline: none; margin-bottom: 12px;
}
.letter-save-btn {
  background: var(--gold); color: white; border: none; border-radius: 12px;
  padding: 10px 20px; cursor: pointer; font-family: 'Lato', sans-serif; font-size: 0.85rem;
  font-weight: 700; transition: background 0.2s;
}
.letter-save-btn:hover { background: #b8922d; }
.letter-unlock-info { font-size: 0.8rem; color: var(--text-light); margin-top: 8px; }
.letter-view {
  background: #fffbe8; border-radius: 12px; padding: 14px;
  border: 1px solid var(--gold); margin-top: 10px; font-size: 0.85rem; line-height: 1.7; color: var(--text);
}
.locked-msg { text-align: center; padding: 16px; color: var(--text-light); font-style: italic; font-size: 0.88rem; }

/* MOOD */
.mood-cal-section { }
.mood-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px,1fr)); gap: 8px; margin: 14px 0; }
.mood-opt {
  padding: 10px 6px; border-radius: 12px; border: 1.5px solid var(--rose-light);
  background: white; cursor: pointer; text-align: center; font-size: 0.75rem; transition: all 0.2s;
}
.mood-opt:hover { border-color: var(--rose); }
.mood-opt.selected { background: var(--rose); color: white; border-color: var(--rose); }
.mood-emoji { font-size: 1.6rem; display: block; margin-bottom: 4px; }
.mood-day-badge { font-size: 0.6rem; position: absolute; bottom: 2px; right: 2px; }

/* DRAWING */
.drawing-container { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
.drawing-section { }
.drawing-name { font-family: 'Playfair Display', serif; font-size: 1rem; color: var(--rose-dark); margin-bottom: 8px; text-align: center; }
.color-palette { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px; }
.color-swatch {
  width: 24px; height: 24px; border-radius: 50%; cursor: pointer;
  border: 2px solid transparent; transition: border-color 0.15s;
}
.color-swatch.active { border-color: #333; }
.drawing-tools { display: flex; gap: 6px; margin-bottom: 8px; flex-wrap: wrap; }
.tool-btn {
  padding: 4px 10px; border-radius: 8px; border: 1.5px solid var(--rose-light);
  background: white; cursor: pointer; font-size: 0.75rem; font-family: 'Lato', sans-serif;
  transition: all 0.2s;
}
.tool-btn.active { background: var(--rose); color: white; border-color: var(--rose); }
canvas.drawing-canvas {
  border-radius: 12px; border: 2px solid var(--rose-light);
  background: white; touch-action: none; width: 100%; cursor: crosshair;
  display: block;
}
.brush-size { display: flex; align-items: center; gap: 6px; margin-bottom: 8px; font-size: 0.78rem; color: var(--text-light); }
.brush-size input { width: 70px; accent-color: var(--rose); }

/* AI CHAT */
.ai-chat-container {
  background: white; border-radius: 20px; overflow: hidden;
  box-shadow: var(--shadow); border: 1px solid var(--rose-light);
  display: flex; flex-direction: column; height: 480px;
}
.ai-chat-msgs {
  flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 10px;
}
.ai-msg {
  max-width: 80%; padding: 10px 14px; border-radius: 16px; font-size: 0.88rem; line-height: 1.6;
}
.ai-msg.bot {
  background: #fff0f5; border: 1px solid var(--rose-light); color: var(--text); align-self: flex-start;
  border-bottom-left-radius: 4px;
}
.ai-msg.user {
  background: var(--rose); color: white; align-self: flex-end;
  border-bottom-right-radius: 4px;
}
.ai-typing { display: flex; gap: 4px; align-items: center; padding: 10px 14px; }
.ai-typing span {
  width: 8px; height: 8px; background: var(--rose); border-radius: 50%;
  animation: typing 1s infinite;
}
.ai-typing span:nth-child(2) { animation-delay: 0.2s; }
.ai-typing span:nth-child(3) { animation-delay: 0.4s; }
@keyframes typing { 0%,100%{opacity:0.3;transform:scale(0.8);} 50%{opacity:1;transform:scale(1);} }
.ai-input-row {
  display: flex; gap: 8px; padding: 12px; border-top: 1px solid var(--rose-light);
}
.ai-input-row input {
  flex: 1; border: 1.5px solid var(--rose-light); border-radius: 20px;
  padding: 10px 16px; font-family: 'Lato', sans-serif; font-size: 0.88rem; outline: none;
}
.ai-input-row input:focus { border-color: var(--rose); }
.ai-send-btn {
  background: var(--rose); color: white; border: none; border-radius: 50%;
  width: 40px; height: 40px; cursor: pointer; font-size: 1.1rem;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.2s;
}
.ai-send-btn:hover { background: var(--rose-dark); }

/* UPLOAD BTN */
.upload-label {
  display: inline-block; padding: 9px 16px; background: #f5e6ea; color: var(--rose-dark);
  border-radius: 10px; cursor: pointer; font-size: 0.82rem; font-weight: 600;
  transition: background 0.2s; margin-bottom: 10px;
}
.upload-label:hover { background: var(--rose-light); }

/* DRAWING CALENDAR EXTRAS */
.selected-draw-day {
  background: linear-gradient(135deg, #ffe0ec, #ffd0e0) !important;
  border: 2px solid var(--rose) !important;
  font-weight: 700;
  color: var(--rose-dark);
}
.cal-day-num { display: block; }
.draw-cal-emoji {
  font-size: 0.7rem;
  display: block;
  cursor: pointer;
  border-radius: 6px;
  padding: 1px 3px;
  background: rgba(232,105,138,0.15);
  transition: background 0.15s;
  line-height: 1.4;
}
.draw-cal-emoji:hover {
  background: rgba(232,105,138,0.4);
}

/* RESPONSIVE */
@media (max-width: 600px) {
  .meeting-grid { grid-template-columns: 1fr; }
  .horoscope-grid { grid-template-columns: 1fr; }
  .zodiac-section { grid-template-columns: 1fr 1fr; }
  .drawing-container { grid-template-columns: 1fr; }
  .stat-value { font-size: 1.1rem; }
}

.page-title-bar {
  font-family: 'Playfair Display', serif; font-size: 1.6rem; color: var(--rose-dark);
  margin-bottom: 20px; display: flex; align-items: center; gap: 8px;
}
</style>
</head>
<body>

<!-- EMOJI RAIN -->
<div id="emoji-rain"></div>

<!-- NAV -->
<nav>
  <div class="nav-logo">T & Y ğŸ’•</div>
  <div class="nav-tabs">
    <button class="tab-btn active" onclick="showPage('home')">ğŸ  Ana Sayfa</button>
    <button class="tab-btn" onclick="showPage('album')">ğŸ“¸ AlbÃ¼m</button>
    <button class="tab-btn" onclick="showPage('memories')">ğŸ“… AnÄ±lar</button>
    <button class="tab-btn" onclick="showPage('mood')">ğŸ˜Š Ruh Hali</button>
    <button class="tab-btn" onclick="showPage('drawing')">ğŸ¨ Ã‡izim</button>
    <button class="tab-btn" onclick="showPage('future')">âœ¨ Gelecek</button>
    <button class="tab-btn" onclick="showPage('ai')">ğŸ¤– Yapay Zeka</button>
    <button class="tab-btn" onclick="showPage('places')">ğŸ“ Gidilen Yerler</button>
  </div>
</nav>

<!-- ======================== HOME PAGE ======================== -->
<div class="page active" id="page-home">
  <div class="home-hero">
    <div class="couple-photos">
      <div class="profile-card">
        <div class="profile-photo-wrap" onclick="changeProfilePhoto('tulay')">
          <div class="profile-photo" id="tulay-photo">
            <span id="tulay-photo-emoji">ğŸ’—</span>
            <img id="tulay-photo-img" src="" style="display:none">
          </div>
          <div class="photo-overlay">
            <span>ğŸ“·</span>
            <span>FotoÄŸraf DeÄŸiÅŸtir</span>
            <span id="tulay-remove-opt" style="display:none" onclick="removePhoto('tulay',event)">ğŸ—‘ï¸ KaldÄ±r</span>
          </div>
        </div>
        <div class="profile-name">TÃ¼lay</div>
      </div>
      <div class="heart-divider">ğŸ’</div>
      <div class="profile-card">
        <div class="profile-photo-wrap" onclick="changeProfilePhoto('yigit')">
          <div class="profile-photo" id="yigit-photo">
            <span id="yigit-photo-emoji">ğŸ’™</span>
            <img id="yigit-photo-img" src="" style="display:none">
          </div>
          <div class="photo-overlay">
            <span>ğŸ“·</span>
            <span>FotoÄŸraf DeÄŸiÅŸtir</span>
            <span id="yigit-remove-opt" style="display:none" onclick="removePhoto('yigit',event)">ğŸ—‘ï¸ KaldÄ±r</span>
          </div>
        </div>
        <div class="profile-name">YiÄŸit</div>
      </div>
    </div>
    <input type="file" id="profile-file-input" accept="image/*" style="display:none" onchange="onProfileFileSelected(event)">

    <div class="couple-title">TÃ¼lay & YiÄŸit</div>
    <div class="couple-sub">Birlikte yazdÄ±ÄŸÄ±mÄ±z en gÃ¼zel hikaye ğŸŒ¹</div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">â¤ï¸</div>
        <div class="stat-label">Birliktelik</div>
        <div class="stat-value" id="days-count">...</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">â±ï¸</div>
        <div class="stat-label">GeÃ§en SÃ¼re</div>
        <div class="stat-value timer" id="time-together">...</div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‚</div>
        <div class="stat-label">TÃ¼lay'Ä±n DoÄŸum GÃ¼nÃ¼</div>
        <div class="stat-value" id="tulay-bday">23 KasÄ±m</div>
        <div style="font-size:0.75rem;color:var(--text-light);margin-top:4px" id="tulay-bday-countdown"></div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ğŸ‚</div>
        <div class="stat-label">YiÄŸit'in DoÄŸum GÃ¼nÃ¼</div>
        <div class="stat-value" id="yigit-bday">2 Nisan</div>
        <div style="font-size:0.75rem;color:var(--text-light);margin-top:4px" id="yigit-bday-countdown"></div>
      </div>
    </div>


    <!-- Ã–PÃœCÃœK SAYACI -->
    <div class="kiss-section">
      <div class="kiss-title">ğŸ’‹ GÃ¼nlÃ¼k Ã–pÃ¼cÃ¼kler</div>
      <div class="kiss-subtitle" id="kiss-date-label"></div>
      <div class="kiss-buttons">
        <div class="kiss-item">
          <button class="kiss-btn kiss-btn-tulay" onclick="addKiss('tulay', this)">
            <span class="kiss-emoji">ğŸ’‹</span>
            <span class="kiss-name">TÃ¼lay'Ä± Ã–p</span>
          </button>
          <div class="kiss-count" id="kiss-count-tulay">0</div>
          <div class="kiss-count-label">Ã¶pÃ¼cÃ¼k bugÃ¼n ğŸ’•</div>
        </div>
        <div class="kiss-item">
          <button class="kiss-btn kiss-btn-yigit" onclick="addKiss('yigit', this)">
            <span class="kiss-emoji">ğŸ’‹</span>
            <span class="kiss-name">YiÄŸit'i Ã–p</span>
          </button>
          <div class="kiss-count" id="kiss-count-yigit">0</div>
          <div class="kiss-count-label">Ã¶pÃ¼cÃ¼k bugÃ¼n ğŸ’™</div>
        </div>
      </div>
      <div class="kiss-reset-note">ğŸ•› Her gece 24:00'da sÄ±fÄ±rlanÄ±r</div>
    </div>

    <div class="zodiac-section">
      <div class="zodiac-card">
        <div class="zodiac-sign">â™</div>
        <div class="zodiac-name">TÃ¼lay â€” Yay</div>
        <div class="zodiac-comment">Ã–zgÃ¼r ruhlu, maceraperest ve iÃ§ten kalpli. Sevdiklerini sonsuz neÅŸeyle sarar. ğŸŒŸ</div>
      </div>
      <div class="zodiac-card">
        <div class="zodiac-sign">â™ˆ</div>
        <div class="zodiac-name">YiÄŸit â€” KoÃ§</div>
        <div class="zodiac-comment">Cesur, enerjik, tutkulu lider. SevdiÄŸini sonuna kadar korur. ğŸ”¥</div>
      </div>
    </div>

    <!-- MOOD MUSIC SECTION -->
    <div id="mood-music-section" style="display:none;background:linear-gradient(135deg,#2d1b2e,#4a1535);border-radius:20px;padding:20px;margin-bottom:20px;color:white;">
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:#f5b8c8;margin-bottom:14px;text-align:center;">ğŸµ Ruh Halinize GÃ¶re MÃ¼zik</div>
      <div id="mood-music-cards" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:14px;"></div>
      <div id="music-player-container" style="display:none;background:rgba(255,255,255,0.1);border-radius:16px;padding:16px;">
        <div id="now-playing-label" style="font-size:0.8rem;color:#f5b8c8;margin-bottom:6px;text-align:center;"></div>
        <div id="now-playing-title" style="font-size:1rem;font-weight:700;text-align:center;margin-bottom:14px;"></div>
        <a id="youtube-link" href="#" target="_blank" style="display:flex;align-items:center;justify-content:center;gap:10px;background:#FF0000;color:white;border-radius:12px;padding:12px;text-decoration:none;font-weight:700;font-size:0.95rem;transition:opacity 0.2s;" onmouseover="this.style.opacity=0.85" onmouseout="this.style.opacity=1">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="white"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg>
          YouTube'da Dinle
        </a>
        <div style="font-size:0.72rem;color:rgba(255,255,255,0.45);text-align:center;margin-top:10px;">ğŸ”€ Her Ã§alda farklÄ± ÅŸarkÄ± Ã¶nerilir</div>
      </div>
    </div>

    <div class="horoscope-section">
      <div class="horoscope-title">âœ¨ GÃ¼nlÃ¼k BurÃ§ Yorumunuz</div>
      <div class="horoscope-grid">
        <div class="horoscope-person">
          <div class="horoscope-person-name">â™ TÃ¼lay (Yay)</div>
          <div class="horoscope-text" id="horoscope-tulay">â³ YÃ¼kleniyor...</div>
        </div>
        <div class="horoscope-person">
          <div class="horoscope-person-name">â™ˆ YiÄŸit (KoÃ§)</div>
          <div class="horoscope-text" id="horoscope-yigit">â³ YÃ¼kleniyor...</div>
        </div>
      </div>
      <button class="horoscope-load-btn" onclick="loadHoroscope()">ğŸ”® YorumlarÄ± Yenile</button>
    </div>

    <!-- UYUM METRESÄ° -->
    <div class="horoscope-section" style="margin-top:0;">
      <div class="horoscope-title">ğŸ’ Yay & KoÃ§ GÃ¼nlÃ¼k Uyum</div>
      <div id="compat-meter-wrap" style="text-align:center;">
        <div style="position:relative;background:#fce8f0;border-radius:20px;height:28px;overflow:hidden;margin-bottom:10px;">
          <div id="compat-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#e8698a,#d4a853);border-radius:20px;transition:width 1.2s ease;"></div>
          <div id="compat-pct" style="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:0.95rem;color:var(--rose-dark);"></div>
        </div>
        <div id="compat-comment" style="font-size:0.83rem;color:var(--text-light);line-height:1.6;">â³ YÃ¼kleniyor...</div>
      </div>
    </div>

    <!-- Ã‡Ä°ZÄ°M VÄ°TRÄ°NÄ° -->
    <div id="drawing-showcase" style="background:linear-gradient(135deg,#fff0f5,#fff8f0);border-radius:20px;padding:20px;margin-bottom:20px;border:1px solid var(--rose-light);box-shadow:var(--shadow);">
      <div style="font-family:'Playfair Display',serif;font-size:1.1rem;color:var(--rose-dark);margin-bottom:14px;text-align:center;">ğŸ¨ Son Ã‡izimler</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;" id="showcase-grid">
        <div style="text-align:center;">
          <div style="font-weight:700;color:var(--rose);font-size:0.85rem;margin-bottom:6px;">ğŸ’• TÃ¼lay'Ä±n Ã‡izimi</div>
          <div id="showcase-tulay" style="background:#fce8f0;border-radius:14px;min-height:120px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--text-light);overflow:hidden;">
            HenÃ¼z Ã§izim yok ğŸ¨
          </div>
          <div id="showcase-tulay-date" style="font-size:0.72rem;color:var(--text-light);margin-top:4px;"></div>
        </div>
        <div style="text-align:center;">
          <div style="font-weight:700;color:#6a9ae8;font-size:0.85rem;margin-bottom:6px;">ğŸ’™ YiÄŸit'in Ã‡izimi</div>
          <div id="showcase-yigit" style="background:#e8f0fc;border-radius:14px;min-height:120px;display:flex;align-items:center;justify-content:center;font-size:0.8rem;color:var(--text-light);overflow:hidden;">
            HenÃ¼z Ã§izim yok ğŸ¨
          </div>
          <div id="showcase-yigit-date" style="font-size:0.72rem;color:var(--text-light);margin-top:4px;"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- YEMEK Ã‡ARKI -->
  <div style="background:linear-gradient(135deg,#fff0f5,#fff8f0);border-radius:24px;padding:24px;margin-bottom:20px;border:1px solid var(--rose-light);box-shadow:var(--shadow);">
    <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--rose-dark);text-align:center;margin-bottom:6px;">ğŸ½ï¸ Ne Yesek Ã‡arkÄ±</div>
    <div style="font-size:0.8rem;color:var(--text-light);text-align:center;margin-bottom:16px;">Karar veremiyorsanÄ±z Ã§arka bÄ±rakÄ±n! ğŸ˜„</div>

    <!-- Yemek ekleme -->
    <div style="display:flex;gap:8px;margin-bottom:14px;">
      <input type="text" id="food-input" placeholder="Yemek yeri ekle... ğŸ•" onkeydown="if(event.key==='Enter')addFood()"
        style="flex:1;border:1.5px solid var(--rose-light);border-radius:12px;padding:10px 14px;font-family:Lato,sans-serif;font-size:0.88rem;outline:none;background:#fff;color:var(--text);">
      <button onclick="addFood()" style="background:var(--rose);color:white;border:none;border-radius:12px;padding:10px 16px;cursor:pointer;font-weight:700;font-size:0.9rem;">+</button>
    </div>
    <div id="food-tags" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px;min-height:32px;"></div>

    <!-- Ã‡ark -->
    <div style="display:flex;flex-direction:column;align-items:center;gap:14px;">
      <div style="position:relative;">
        <div style="position:absolute;top:-18px;left:50%;transform:translateX(-50%);font-size:1.8rem;z-index:10;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3));">â–¼</div>
        <canvas id="wheel-canvas" width="280" height="280" onclick="spinWheel()" style="cursor:pointer;border-radius:50%;box-shadow:0 8px 32px rgba(232,105,138,0.3);display:block;"></canvas>
      </div>
      <button onclick="spinWheel()" id="spin-btn" style="background:linear-gradient(135deg,var(--rose),var(--rose-dark));color:white;border:none;border-radius:20px;padding:12px 32px;cursor:pointer;font-family:'Playfair Display',serif;font-size:1.1rem;box-shadow:0 4px 18px rgba(232,105,138,0.4);transition:transform 0.1s;">
        ğŸ¡ Ã‡evir!
      </button>
      <div id="wheel-result" style="font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--rose-dark);text-align:center;min-height:32px;"></div>
    </div>
  </div>

  <!-- YAZI TURA -->
  <div style="background:linear-gradient(135deg,#2d1b2e,#4a2545);border-radius:24px;padding:24px;margin-bottom:20px;box-shadow:0 12px 40px rgba(45,27,46,0.4);text-align:center;">
    <div style="font-family:'Playfair Display',serif;font-size:1.3rem;color:#f5b8c8;margin-bottom:6px;">ğŸª™ YazÄ± mÄ± Tura mÄ±?</div>
    <div style="font-size:0.8rem;color:rgba(255,255,255,0.6);margin-bottom:20px;">AklÄ±ndan tut, sonra Ã§evir!</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
      <div style="background:rgba(255,255,255,0.1);border-radius:16px;padding:14px;">
        <div style="font-size:1.6rem;margin-bottom:4px;">ğŸ’•</div>
        <div style="color:#f5b8c8;font-weight:700;font-size:0.9rem;">YAZI</div>
        <div style="color:rgba(255,255,255,0.6);font-size:0.75rem;">TÃ¼lay kazanÄ±r</div>
      </div>
      <div style="background:rgba(255,255,255,0.1);border-radius:16px;padding:14px;">
        <div style="font-size:1.6rem;margin-bottom:4px;">ğŸ’™</div>
        <div style="color:#a0c4f5;font-weight:700;font-size:0.9rem;">TURA</div>
        <div style="color:rgba(255,255,255,0.6);font-size:0.75rem;">YiÄŸit kazanÄ±r</div>
      </div>
    </div>
    <div style="position:relative;display:inline-block;margin-bottom:20px;">
      <canvas id="coin-canvas" width="160" height="160" style="display:block;cursor:pointer;" onclick="flipCoin()"></canvas>
    </div>
    <br>
    <button onclick="flipCoin()" id="coin-btn" style="background:linear-gradient(135deg,#d4a853,#e8c070);color:#2d1b2e;border:none;border-radius:20px;padding:12px 32px;cursor:pointer;font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;box-shadow:0 4px 18px rgba(212,168,83,0.5);">
      ğŸª™ Ã‡evir!
    </button>
    <div id="coin-result" style="margin-top:14px;font-family:'Playfair Display',serif;font-size:1.3rem;color:#f5b8c8;min-height:36px;"></div>
  </div>

  <!-- FIRST MEETING -->
  <div class="meeting-section">
    <div class="meeting-title">ğŸ’« Ä°lk BuluÅŸmamÄ±z â€” 22 AÄŸustos 2025</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;align-items:start;">
      <div class="weather-moon">
        <div class="weather-box">
          <div class="weather-icon">â˜€ï¸ğŸŒ¡ï¸</div>
          <div class="weather-desc"><strong>~32Â°C Â· GÃ¼neÅŸli & SÄ±cak</strong><br>Ä°stanbul'da AÄŸustos ortasÄ±nda tipik yaz havasÄ± â€” tÄ±pkÄ± o anki duygular gibi sÄ±cak â˜€ï¸</div>
        </div>
        <div class="moon-box">
          <div class="moon-icon">ğŸŒ‘</div>
          <div class="moon-desc"><strong>Yeni Ay</strong><br>23 AÄŸustos 2025'te Yeni Ay. BuluÅŸmanÄ±z yeni bir dÃ¶ngÃ¼nÃ¼n, yeni bir aÅŸkÄ±n baÅŸlangÄ±cÄ± ğŸŒ‘âœ¨</div>
        </div>
      </div>
      <div>
        <div style="font-size:0.82rem;color:#f5b8c8;margin-bottom:8px;">ğŸ“ Alpaslan Sk. Orta, Kartal/Ä°stanbul</div>
        <div style="border-radius:16px;overflow:hidden;box-shadow:0 4px 20px rgba(0,0,0,0.3);">
          <iframe
            src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d756.8!2d29.1869!3d40.8892!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x14cac0be89e9e85d%3A0x5fa1bdf73a8e1f1e!2sAlpaslan%20Sk.%2C%2034880%20Kartal%2F%C4%B0stanbul!5e0!3m2!1str!2str!4v1700000000000!5m2!1str!2str"
            width="100%" height="200" style="border:0;display:block;" allowfullscreen="" loading="lazy"
            referrerpolicy="no-referrer-when-downgrade">
          </iframe>
        </div>
        <a class="map-btn" href="https://maps.google.com/?q=Alpaslan+Sk.+Kartal+Istanbul" target="_blank" style="margin-top:8px;display:block;">ğŸ—ºï¸ Google Maps'te AÃ§</a>
      </div>
    </div>
  </div>
</div>

<!-- ======================== ALBUM PAGE ======================== -->
<div class="page" id="page-album">
  <div class="page-title-bar">ğŸ“¸ FotoÄŸraf AlbÃ¼mÃ¼</div>
  <div class="album-header">
    <div style="font-size:0.88rem;color:var(--text-light)">Birlikte Ã§ektiÄŸiniz anlar ğŸ’•</div>
    <button class="add-btn" onclick="openAlbumModal()">+ FotoÄŸraf Ekle</button>
  </div>
  <div class="album-grid" id="album-grid">
    <div style="text-align:center;color:var(--text-light);padding:40px;grid-column:1/-1;font-size:0.9rem;">
      HenÃ¼z fotoÄŸraf eklenmedi ğŸ“·<br>Ä°lk anÄ±nÄ±zÄ± ekleyin!
    </div>
  </div>
</div>

<!-- ALBUM MODAL -->
<div class="modal-backdrop" id="album-modal">
  <div class="modal">
    <div class="modal-title">ğŸ“¸ FotoÄŸraf Ekle</div>
    <button class="modal-close" onclick="closeModal('album-modal')">âœ•</button>
    <label class="upload-label" for="album-file-input">ğŸ“ FotoÄŸraf SeÃ§</label>
    <input type="file" id="album-file-input" accept="image/*" style="display:none" onchange="onAlbumFileSelected(event)">
    <div id="album-preview-wrap" style="display:none;margin-bottom:12px;">
      <img id="album-preview-img" style="width:100%;border-radius:12px;max-height:200px;object-fit:cover;">
    </div>
    <input type="text" id="album-caption-input" placeholder="AÃ§Ä±klama yaz (opsiyonel) ğŸ’¬">
    <button class="modal-save-btn" onclick="saveAlbumPhoto()">ğŸ’¾ Kaydet</button>
  </div>
</div>

<!-- ======================== MEMORIES PAGE ======================== -->
<div class="page" id="page-memories">
  <div class="memories-header">
    <div class="page-title-bar" style="margin-bottom:0">ğŸ“… AnÄ±lar</div>
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="changeMemMonth(-1)">â€¹</button>
      <div class="cal-month-label" id="mem-month-label"></div>
      <button class="cal-nav-btn" onclick="changeMemMonth(1)">â€º</button>
    </div>
  </div>
  <div class="calendar-grid">
    <div class="cal-days-header">
      <div class="cal-day-header">Paz</div>
      <div class="cal-day-header">Pzt</div>
      <div class="cal-day-header">Sal</div>
      <div class="cal-day-header">Ã‡ar</div>
      <div class="cal-day-header">Per</div>
      <div class="cal-day-header">Cum</div>
      <div class="cal-day-header">Cmt</div>
    </div>
    <div class="cal-days-body" id="mem-calendar-body"></div>
  </div>
  <div style="margin-top:12px;font-size:0.8rem;color:var(--text-light);display:flex;gap:16px;flex-wrap:wrap;">
    <span>ğŸ¤ BuluÅŸma gÃ¼nÃ¼</span>
    <span>ğŸ’• AnÄ± var</span>
  </div>
</div>

<!-- MEMORY MODAL -->
<div class="modal-backdrop" id="memory-modal">
  <div class="modal">
    <div class="modal-title" id="memory-modal-date">ğŸ“ AnÄ±</div>
    <button class="modal-close" onclick="closeModal('memory-modal')">âœ•</button>
    <div class="check-row">
      <input type="checkbox" id="meetup-check" onchange="saveMeetupCheck()">
      <label for="meetup-check">ğŸ¤ Bu gÃ¼n buluÅŸtuk</label>
    </div>
    <textarea id="memory-text" rows="4" placeholder="Bu gÃ¼n neler yaptÄ±nÄ±z? NasÄ±l geÃ§ti? ğŸ’­"></textarea>
    <label class="upload-label" for="memory-file-input">ğŸ“· Resim Ekle</label>
    <input type="file" id="memory-file-input" accept="image/*" style="display:none" onchange="onMemoryFileSelected(event)">
    <div id="memory-img-preview" style="display:none;margin-bottom:10px;">
      <img id="memory-img-preview-img" style="width:100%;border-radius:12px;max-height:160px;object-fit:cover;">
      <button class="memory-item-img-del" onclick="clearMemoryImg()">ğŸ—‘ï¸ Resmi KaldÄ±r</button>
    </div>
    <button class="modal-save-btn" onclick="saveMemory()">ğŸ’¾ Kaydet</button>
    <div class="memory-preview" id="memory-saved-list"></div>
  </div>
</div>

<!-- ======================== MOOD PAGE ======================== -->
<div class="page" id="page-mood">
  <div class="memories-header">
    <div class="page-title-bar" style="margin-bottom:0">ğŸ˜Š Ruh Hali Takvimi</div>
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="changeMoodMonth(-1)">â€¹</button>
      <div class="cal-month-label" id="mood-month-label"></div>
      <button class="cal-nav-btn" onclick="changeMoodMonth(1)">â€º</button>
    </div>
  </div>
  <div class="calendar-grid">
    <div class="cal-days-header">
      <div class="cal-day-header">Paz</div>
      <div class="cal-day-header">Pzt</div>
      <div class="cal-day-header">Sal</div>
      <div class="cal-day-header">Ã‡ar</div>
      <div class="cal-day-header">Per</div>
      <div class="cal-day-header">Cum</div>
      <div class="cal-day-header">Cmt</div>
    </div>
    <div class="cal-days-body" id="mood-calendar-body"></div>
  </div>
</div>

<!-- MOOD MODAL -->
<div class="modal-backdrop" id="mood-modal">
  <div class="modal">
    <div class="modal-title" id="mood-modal-date">BugÃ¼n Ruh Haliniz</div>
    <button class="modal-close" onclick="closeModal('mood-modal')">âœ•</button>
    <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:8px;">ğŸ’• TÃ¼lay</p>
    <div class="mood-items" id="mood-items-tulay"></div>
    <p style="font-size:0.85rem;color:var(--text-light);margin-bottom:8px;margin-top:8px;">ğŸ’™ YiÄŸit</p>
    <div class="mood-items" id="mood-items-yigit"></div>
    <button class="modal-save-btn" onclick="saveMood()">ğŸ’¾ Kaydet</button>
  </div>
</div>

<!-- ======================== DRAWING PAGE ======================== -->
<div class="page" id="page-drawing">
  <div class="page-title-bar">ğŸ¨ Ã‡izim AlanÄ±</div>
  <div class="memories-header" style="margin-bottom:14px;">
    <div style="font-size:0.88rem;color:var(--text-light)">Kendi tuvalinizi Ã§izin ğŸ–Œï¸</div>
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="changeDrawMonth(-1)">â€¹</button>
      <div class="cal-month-label" id="draw-month-label"></div>
      <button class="cal-nav-btn" onclick="changeDrawMonth(1)">â€º</button>
    </div>
  </div>
  <div class="calendar-grid" style="margin-bottom:14px;">
    <div class="cal-days-header">
      <div class="cal-day-header">Paz</div>
      <div class="cal-day-header">Pzt</div>
      <div class="cal-day-header">Sal</div>
      <div class="cal-day-header">Ã‡ar</div>
      <div class="cal-day-header">Per</div>
      <div class="cal-day-header">Cum</div>
      <div class="cal-day-header">Cmt</div>
    </div>
    <div class="cal-days-body" id="draw-calendar-body"></div>
  </div>
  <div class="drawing-container" id="drawing-canvases" style="display:none;">
    <div class="drawing-section">
      <div class="drawing-name">ğŸ’• TÃ¼lay'Ä±n Tuvali</div>
      <div class="color-palette" id="palette-tulay"></div>
      <div class="brush-size"><span>FÄ±rÃ§a:</span><input type="range" min="1" max="30" value="5" id="brush-tulay" oninput="updateBrush('tulay',this.value)"><span id="brush-val-tulay">5px</span></div>
      <div class="drawing-tools">
        <button class="tool-btn active" id="tool-tulay-draw" onclick="setTool('tulay','draw')">âœï¸ Ã‡iz</button>
        <button class="tool-btn" id="tool-tulay-erase" onclick="setTool('tulay','erase')">ğŸ§¹ Sil</button>
        <button class="tool-btn" onclick="clearCanvas('tulay')">ğŸ—‘ï¸ Temizle</button>
        <button class="tool-btn" onclick="saveCanvasImg('tulay')">ğŸ’¾ Kaydet</button>
      </div>
      <canvas class="drawing-canvas" id="canvas-tulay" width="400" height="350"></canvas>
    </div>
    <div class="drawing-section">
      <div class="drawing-name">ğŸ’™ YiÄŸit'in Tuvali</div>
      <div class="color-palette" id="palette-yigit"></div>
      <div class="brush-size"><span>FÄ±rÃ§a:</span><input type="range" min="1" max="30" value="5" id="brush-yigit" oninput="updateBrush('yigit',this.value)"><span id="brush-val-yigit">5px</span></div>
      <div class="drawing-tools">
        <button class="tool-btn active" id="tool-yigit-draw" onclick="setTool('yigit','draw')">âœï¸ Ã‡iz</button>
        <button class="tool-btn" id="tool-yigit-erase" onclick="setTool('yigit','erase')">ğŸ§¹ Sil</button>
        <button class="tool-btn" onclick="clearCanvas('yigit')">ğŸ—‘ï¸ Temizle</button>
        <button class="tool-btn" onclick="saveCanvasImg('yigit')">ğŸ’¾ Kaydet</button>
      </div>
      <canvas class="drawing-canvas" id="canvas-yigit" width="400" height="350"></canvas>
    </div>
  </div>
  <div id="drawing-pick-msg" style="text-align:center;padding:30px;color:var(--text-light);font-size:0.9rem;">
    Bir gÃ¼n seÃ§in ve Ã§izmeye baÅŸlayÄ±n! ğŸ¨
  </div>
</div>

<!-- ======================== FUTURE PAGE ======================== -->
<div class="page" id="page-future">
  <div class="page-title-bar">âœ¨ Gelecek Hayaller</div>
  <p style="font-size:0.88rem;color:var(--text-light);margin-bottom:20px;">Birlikte hayal ettiÄŸiniz her ÅŸey burada ğŸŒˆ</p>

  <div class="dream-input-row">
    <input type="text" id="dream-input" placeholder="Bir hayalinizi yazÄ±n... ğŸ’­">
    <div class="dream-who">
      <button class="who-btn active" id="who-both" onclick="setDreamWho('both')">ğŸ’• Ä°kimiz</button>
      <button class="who-btn" id="who-tulay" onclick="setDreamWho('tulay')">T</button>
      <button class="who-btn" id="who-yigit" onclick="setDreamWho('yigit')">Y</button>
    </div>
    <button class="add-btn" onclick="addDream()">+ Ekle</button>
  </div>
  <ul class="dreams-list" id="dreams-list"></ul>

  <div class="letter-section">
    <div class="section-title">ğŸ’Œ GeleceÄŸe Mektup</div>
    <div class="letter-subtitle">Mektubunuzu yazÄ±n â€” 1 ay sonra aÃ§Ä±lacak ğŸ”</div>
    <div class="letter-tabs">
      <button class="letter-tab active" onclick="setLetterTab('tulay')">ğŸ’• TÃ¼lay'Ä±n Mektubu</button>
      <button class="letter-tab" onclick="setLetterTab('yigit')">ğŸ’™ YiÄŸit'in Mektubu</button>
    </div>
    <div id="letter-content-area"></div>
  </div>
</div>

<!-- ======================== AI PAGE ======================== -->
<div class="page" id="page-ai">
  <div class="page-title-bar">ğŸ¤– Yapay Zeka AsistanÄ±</div>
  <p style="font-size:0.88rem;color:var(--text-light);margin-bottom:16px;">TÃ¼lay & YiÄŸit'in Ã¶zel yapay zeka asistanÄ± â€” her sorunuzu cevaplayalÄ±m! ğŸ’•</p>
  <div class="ai-chat-container">
    <div class="ai-chat-msgs" id="ai-chat-msgs">
      <div class="ai-msg bot">Merhaba TÃ¼lay & YiÄŸit! ğŸ’• Ben sizin Ã¶zel botunuzum. NasÄ±l hissediyorsunuz, ne dÃ¼ÅŸÃ¼nÃ¼yorsunuz? Her ÅŸeyi anlatabilirsiniz! ğŸŒ¸</div>
    </div>
    <div class="ai-input-row">
      <input type="text" id="ai-input" placeholder="Bir ÅŸeyler sorun..." onkeydown="if(event.key==='Enter')sendAIMessage()">
      <button class="ai-send-btn" onclick="sendAIMessage()">â¤</button>
    </div>
  </div>
</div>

<script type="module">
// ===== FIREBASE SETUP =====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, set, get, onValue } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyD1EqYng7qYIuKIQJ32crDz2Btzr0Gjnek",
  authDomain: "tulay-yigit-2.firebaseapp.com",
  databaseURL: "https://tulay-yigit-2-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "tulay-yigit-2",
  storageBucket: "tulay-yigit-2.firebasestorage.app",
  messagingSenderId: "89131064901",
  appId: "1:89131064901:web:de8541e5072a6bdd918d2c"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// ===== STATE =====
let state = {
  album: [],
  memories: {},
  mood: {},
  dreams: [],
  letters: { tulay: null, yigit: null },
  drawings: {},
  profilePhotos: { tulay: null, yigit: null },
  places: {},
  kisses: {}
};

// KayÄ±t gÃ¶stergesi
function showSaving() {
  let el = document.getElementById('save-indicator');
  if(!el) {
    el = document.createElement('div');
    el.id = 'save-indicator';
    el.style.cssText = 'position:fixed;bottom:20px;right:20px;background:#4CAF50;color:white;padding:8px 18px;border-radius:20px;font-size:0.8rem;z-index:9999;transition:opacity 0.5s;box-shadow:0 2px 12px rgba(0,0,0,0.2);font-family:Lato,sans-serif;';
    document.body.appendChild(el);
  }
  el.textContent = 'â˜ï¸ Kaydedildi!';
  el.style.opacity = '1';
  setTimeout(() => { el.style.opacity = '0'; }, 2000);
}

function saveState() {
  set(ref(db, 'state'), state)
    .then(() => showSaving())
    .catch(err => console.error('KayÄ±t hatasÄ±:', err));
  try { localStorage.setItem('ty-state', JSON.stringify(state)); } catch(e) {}
}

async function loadState() {
  try {
    const snap = await get(ref(db, 'state'));
    if(snap.exists()) {
      const d = snap.val();
      state.album = d.album || [];
      state.memories = d.memories || {};
      state.mood = d.mood || {};
      state.dreams = d.dreams || [];
      state.letters = d.letters || { tulay: null, yigit: null };
      state.drawings = d.drawings || {};
      state.profilePhotos = d.profilePhotos || { tulay: null, yigit: null };
      state.places = d.places || {};
      state.kisses = d.kisses || {};
    } else {
      const local = JSON.parse(localStorage.getItem('ty-state') || 'null');
      if(local) { state = { ...state, ...local }; saveState(); }
    }
  } catch(err) {
    const local = JSON.parse(localStorage.getItem('ty-state') || 'null');
    if(local) state = { ...state, ...local };
  }

  onValue(ref(db, 'state'), (snap) => {
    if(!snap.exists()) return;
    const d = snap.val();
    state.album = d.album || [];
    state.memories = d.memories || {};
    state.mood = d.mood || {};
    state.dreams = d.dreams || [];
    state.letters = d.letters || { tulay: null, yigit: null };
    state.drawings = d.drawings || {};
    state.profilePhotos = d.profilePhotos || { tulay: null, yigit: null };
    state.places = d.places || {};
    state.kisses = d.kisses || {};
    // Sadece sayÄ±larÄ± gÃ¼ncelle, sÄ±fÄ±rlama dÃ¶ngÃ¼sÃ¼nÃ¼ Ã¶nle
    const _today = toDateStr(new Date());
    if(state.kisses[_today]) {
      const el1 = document.getElementById('kiss-count-tulay');
      const el2 = document.getElementById('kiss-count-yigit');
      if(el1) el1.textContent = state.kisses[_today].tulay || 0;
      if(el2) el2.textContent = state.kisses[_today].yigit || 0;
    }
    applyProfilePhoto('tulay');
    applyProfilePhoto('yigit');
    renderAlbum();
    renderMemCalendar();
    renderMoodCalendar();
    renderDrawCalendar();
    renderFuture();
    updateMoodSongSuggestion();
    renderDrawingShowcase();
  });

  bootApp();
}

// Global helper (bootApp iÃ§inde de tanÄ±mlÄ± ama dÄ±ÅŸarÄ±dan da eriÅŸim iÃ§in)
function toDateStr(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }

function bootApp() {

// ===== EMOJI RAIN =====
const emojis = ['ğŸ’•','ğŸŒ¹','ğŸ’—','ğŸ’–','âœ¨','ğŸŒ¸','ğŸ’','ğŸ’Œ','ğŸŒ·','â¤ï¸','ğŸ¥€','ğŸ’','ğŸŒº','ğŸ’«','ğŸ¦‹'];
const rain = document.getElementById('emoji-rain');
function createDrop() {
  const el = document.createElement('div');
  el.className = 'emoji-drop';
  el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
  el.style.left = Math.random()*100 + 'vw';
  el.style.animationDuration = (6+Math.random()*10) + 's';
  el.style.animationDelay = (Math.random()*4) + 's';
  el.style.fontSize = (0.9+Math.random()*1.2) + 'rem';
  rain.appendChild(el);
  setTimeout(()=>el.remove(), 20000);
}
setInterval(createDrop, 600);
for(let i=0;i<18;i++) setTimeout(createDrop, i*200);

// ===== NAVIGATION =====
function showPage(id) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  // Aktif tab butonunu iÅŸaretle
  document.querySelectorAll('.tab-btn').forEach(b => {
    if(b.getAttribute('onclick') && b.getAttribute('onclick').includes("'"+id+"'")) b.classList.add('active');
  });
  if(id==='memories') renderMemCalendar();
  if(id==='mood') renderMoodCalendar();
  if(id==='drawing') renderDrawCalendar();
  if(id==='future') renderFuture();
  if(id==='places') renderPlacesCalendar();
}

// ===== HOME STATS =====
const START = new Date('2025-08-22T00:00:00');
function updateStats() {
  const now = new Date();
  const diff = now - START;
  const days = Math.floor(diff/(1000*60*60*24));
  document.getElementById('days-count').textContent = days + ' GÃ¼n';
  const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60));
  const m = Math.floor((diff%(1000*60*60))/(1000*60));
  const s = Math.floor((diff%(1000*60))/1000);
  document.getElementById('time-together').textContent = `${days}g ${h}sa ${m}dk ${s}sn`;

  // Birthdays countdown
  function bdayCountdown(month, day) {
    const today = new Date();
    let next = new Date(today.getFullYear(), month-1, day);
    if(next < today) next.setFullYear(today.getFullYear()+1);
    const diff2 = next - today;
    const dd = Math.ceil(diff2/(1000*60*60*24));
    if(dd===0) return 'ğŸ‰ BugÃ¼n!';
    return dd + ' gÃ¼n kaldÄ±';
  }
  document.getElementById('tulay-bday-countdown').textContent = bdayCountdown(11,23);
  document.getElementById('yigit-bday-countdown').textContent = bdayCountdown(4,2);
}
setInterval(updateStats, 1000);
updateStats();

// ===== PROFILE PHOTOS =====
let currentProfileTarget = null;
function changeProfilePhoto(who) {
  currentProfileTarget = who;
  document.getElementById('profile-file-input').click();
}
function onProfileFileSelected(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    state.profilePhotos[currentProfileTarget] = ev.target.result;
    saveState();
    applyProfilePhoto(currentProfileTarget);
  };
  reader.readAsDataURL(file);
  e.target.value='';
}
function applyProfilePhoto(who) {
  const src = state.profilePhotos[who];
  const img = document.getElementById(who+'-photo-img');
  const emoji = document.getElementById(who+'-photo-emoji');
  const removeOpt = document.getElementById(who+'-remove-opt');
  if(src) {
    img.src = src; img.style.display='block'; emoji.style.display='none'; removeOpt.style.display='inline';
  } else {
    img.style.display='none'; emoji.style.display='inline'; removeOpt.style.display='none';
  }
}
function removePhoto(who, e) {
  e.stopPropagation();
  state.profilePhotos[who] = null;
  saveState(); applyProfilePhoto(who);
}
applyProfilePhoto('tulay'); applyProfilePhoto('yigit');

// ===== HOROSCOPE =====
// GÃ¼nlÃ¼k cache key'i
function horoscopeCacheKey() {
  const d = new Date();
  return `horoscope-${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
}

async function loadHoroscope() {
  const btn = document.querySelector('.horoscope-load-btn');
  btn.textContent = 'â³ YÃ¼kleniyor...';
  btn.disabled = true;

  const today = new Date();
  const dateStr = today.toLocaleDateString('tr-TR', {day:'numeric', month:'long', year:'numeric'});
  const cacheKey = horoscopeCacheKey();

  // BugÃ¼nkÃ¼ cache varsa kullan
  try {
    const cached = sessionStorage.getItem(cacheKey);
    if(cached) {
      const p = JSON.parse(cached);
      applyHoroscope(p);
      btn.textContent = 'ğŸ”® YorumlarÄ± Yenile'; btn.disabled = false;
      return;
    }
  } catch(e) {}

  try {
    const resp = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model: 'claude-sonnet-4-6',
        max_tokens: 600,
        messages: [{
          role: 'user',
          content: `BugÃ¼n ${dateStr} iÃ§in Yay ve KoÃ§ burÃ§larÄ±na kÄ±sa, romantik, pozitif gÃ¼nlÃ¼k burÃ§ yorumu yaz. AyrÄ±ca bu iki burcun bugÃ¼nkÃ¼ uyumunu 55-99 arasÄ±nda bir sayÄ± ve tek cÃ¼mle yorum olarak ver. JSON olarak dÃ¶ndÃ¼r: {"sagittarius":"yorum","aries":"yorum","compat_pct":85,"compat_comment":"yorum"}. TÃ¼rkÃ§e, max 60 kelime her yorum.`
        }]
      })
    });
    const data = await resp.json();
    const text = data.content?.[0]?.text || '';
    const clean = text.replace(/```json?/g,'').replace(/```/g,'').trim();
    const parsed = JSON.parse(clean);
    try { sessionStorage.setItem(cacheKey, JSON.stringify(parsed)); } catch(e) {}
    applyHoroscope(parsed);
  } catch(err) {
    const fallback = {
      sagittarius: 'âœ¨ BugÃ¼n aÅŸk enerjisi Ã§ok yÃ¼ksek! Partnerinizle kaliteli zaman geÃ§irin, duygularÄ±nÄ±zÄ± paylaÅŸÄ±n. Samimiyetiniz iliÅŸkinizi gÃ¼Ã§lendirecek.',
      aries: 'ğŸ”¥ BugÃ¼n cesur adÄ±mlar atma gÃ¼nÃ¼! SevdiÄŸinize sÃ¼rpriz yapÄ±n. Enerji yÃ¼ksek, iletiÅŸim kanallarÄ± aÃ§Ä±k â€” romantik bir gÃ¼n sizi bekliyor.',
      compat_pct: 88,
      compat_comment: 'ğŸ’ Yay ve KoÃ§ enerjileri bugÃ¼n mÃ¼kemmel uyum iÃ§inde â€” birlikte her ÅŸey daha parlak!'
    };
    applyHoroscope(fallback);
  }
  btn.textContent = 'ğŸ”® YorumlarÄ± Yenile'; btn.disabled = false;
}

function applyHoroscope(parsed) {
  document.getElementById('horoscope-tulay').textContent = parsed.sagittarius || 'Yorum alÄ±namadÄ±.';
  document.getElementById('horoscope-yigit').textContent = parsed.aries || 'Yorum alÄ±namadÄ±.';
  // Uyum metresi
  const pct = Math.min(99, Math.max(1, parseInt(parsed.compat_pct) || 88));
  setTimeout(() => {
    document.getElementById('compat-bar').style.width = pct + '%';
    document.getElementById('compat-pct').textContent = pct + '%';
  }, 200);
  document.getElementById('compat-comment').textContent = parsed.compat_comment || '';
}

// Sayfa yÃ¼klenince otomatik yÃ¼kle
setTimeout(() => loadHoroscope(), 800);

// ===== ALBUM =====
let albumFileData = null;
function openAlbumModal() {
  albumFileData = null;
  document.getElementById('album-preview-wrap').style.display='none';
  document.getElementById('album-caption-input').value='';
  openModal('album-modal');
}
function onAlbumFileSelected(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    albumFileData = ev.target.result;
    document.getElementById('album-preview-img').src = albumFileData;
    document.getElementById('album-preview-wrap').style.display='block';
  };
  reader.readAsDataURL(file);
}
function saveAlbumPhoto() {
  if(!albumFileData) { alert('LÃ¼tfen bir fotoÄŸraf seÃ§in.'); return; }
  const caption = document.getElementById('album-caption-input').value.trim();
  state.album.push({ id: Date.now(), src: albumFileData, caption });
  saveState(); renderAlbum();
  closeModal('album-modal');
  document.getElementById('album-file-input').value='';
}
function renderAlbum() {
  const grid = document.getElementById('album-grid');
  if(!state.album.length) {
    grid.innerHTML = '<div style="text-align:center;color:var(--text-light);padding:40px;grid-column:1/-1;font-size:0.9rem;">HenÃ¼z fotoÄŸraf eklenmedi ğŸ“·<br>Ä°lk anÄ±nÄ±zÄ± ekleyin!</div>';
    return;
  }
  grid.innerHTML = state.album.map(p=>`
    <div class="album-item">
      <img src="${p.src}" alt="${p.caption||''}">
      <div class="album-item-actions">
        <button class="album-del-btn" onclick="deleteAlbumPhoto(${p.id})">ğŸ—‘ï¸</button>
      </div>
      ${p.caption ? `<div class="album-caption">${p.caption}</div>` : ''}
    </div>
  `).join('');
}
function deleteAlbumPhoto(id) {
  if(!confirm('Bu fotoÄŸrafÄ± silmek istiyor musunuz?')) return;
  state.album = state.album.filter(p=>p.id!==id);
  saveState(); renderAlbum();
}
renderAlbum();

// ===== MEMORIES CALENDAR =====
let memMonth = new Date().getMonth(), memYear = new Date().getFullYear();
let currentMemDate = null, currentMemImg = null;
const START_DATE = '2025-08-22';

function renderMemCalendar() {
  const label = document.getElementById('mem-month-label');
  label.textContent = new Date(memYear, memMonth).toLocaleDateString('tr-TR', {month:'long', year:'numeric'});
  const body = document.getElementById('mem-calendar-body');
  body.innerHTML = '';
  const first = new Date(memYear, memMonth, 1).getDay();
  const days = new Date(memYear, memMonth+1, 0).getDate();
  const prevDays = new Date(memYear, memMonth, 0).getDate();
  for(let i=0; i<first; i++) {
    const d = document.createElement('div');
    d.className='cal-day other-month'; d.textContent=prevDays-first+i+1; body.appendChild(d);
  }
  const today = new Date(); const todayStr = toDateStr(today);
  for(let d=1; d<=days; d++) {
    const el = document.createElement('div');
    el.className = 'cal-day';
    const ds = `${memYear}-${String(memMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(ds===todayStr) el.classList.add('today');
    if(ds===START_DATE) el.classList.add('start-day');
    const mem = state.memories[ds];
    if(mem?.meetup) el.classList.add('is-meetup');
    if(mem?.text) el.classList.add('has-memory');
    el.textContent = d;
    el.onclick = () => openMemoryModal(ds, d);
    body.appendChild(el);
  }
  let remaining = 42 - first - days;
  for(let i=1; i<=remaining; i++) {
    const d = document.createElement('div'); d.className='cal-day other-month'; d.textContent=i; body.appendChild(d);
  }
}
function changeMemMonth(dir) { memMonth += dir; if(memMonth>11){memMonth=0;memYear++;} if(memMonth<0){memMonth=11;memYear--;} renderMemCalendar(); }
function toDateStr(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }

function openMemoryModal(ds, day) {
  currentMemDate = ds; currentMemImg = null;
  const mem = state.memories[ds] || {};
  document.getElementById('memory-modal-date').textContent = `ğŸ“ ${new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})}`;
  document.getElementById('meetup-check').checked = !!mem.meetup;
  document.getElementById('memory-text').value = mem.text || '';
  document.getElementById('memory-img-preview').style.display='none';
  document.getElementById('memory-file-input').value='';
  renderSavedMemories(ds);
  openModal('memory-modal');
}
function onMemoryFileSelected(e) {
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    currentMemImg = ev.target.result;
    document.getElementById('memory-img-preview-img').src = currentMemImg;
    document.getElementById('memory-img-preview').style.display='block';
  };
  reader.readAsDataURL(file);
}
function clearMemoryImg() { currentMemImg=null; document.getElementById('memory-img-preview').style.display='none'; document.getElementById('memory-file-input').value=''; }
function saveMeetupCheck() {
  if(!currentMemDate) return;
  if(!state.memories[currentMemDate]) state.memories[currentMemDate] = {};
  state.memories[currentMemDate].meetup = document.getElementById('meetup-check').checked;
  saveState(); renderMemCalendar();
}
function saveMemory() {
  const text = document.getElementById('memory-text').value.trim();
  if(!text && !currentMemImg) { alert('Bir ÅŸeyler yazÄ±n veya resim ekleyin.'); return; }
  if(!state.memories[currentMemDate]) state.memories[currentMemDate] = {};
  if(!state.memories[currentMemDate].entries) state.memories[currentMemDate].entries = [];
  state.memories[currentMemDate].entries.push({ id: Date.now(), text, img: currentMemImg });
  if(text) state.memories[currentMemDate].text = true;
  state.memories[currentMemDate].meetup = document.getElementById('meetup-check').checked;
  saveState();
  document.getElementById('memory-text').value='';
  clearMemoryImg();
  renderSavedMemories(currentMemDate);
  renderMemCalendar();
}
function renderSavedMemories(ds) {
  const cont = document.getElementById('memory-saved-list');
  const entries = state.memories[ds]?.entries || [];
  if(!entries.length) { cont.innerHTML=''; return; }
  cont.innerHTML = '<div style="font-weight:600;color:var(--rose);margin-bottom:8px;font-size:0.85rem;">ğŸ’• KayÄ±tlÄ± AnÄ±lar</div>' +
    entries.map(e=>`
      <div class="memory-item">
        <button class="memory-item-del" onclick="deleteMemoryEntry('${ds}',${e.id})">ğŸ—‘ï¸ Sil</button>
        ${e.text ? `<div class="memory-item-text">${e.text}</div>` : ''}
        ${e.img ? `<div><img class="memory-item-img" src="${e.img}"><br><button class="memory-item-img-del" onclick="deleteMemoryEntryImg('${ds}',${e.id})">ğŸ—‘ï¸ Resmi Sil</button></div>` : ''}
      </div>
    `).join('');
}
function deleteMemoryEntry(ds, id) {
  if(!confirm('Bu anÄ±yÄ± silmek istiyor musunuz?')) return;
  state.memories[ds].entries = state.memories[ds].entries.filter(e=>e.id!==id);
  if(!state.memories[ds].entries.length) { state.memories[ds].text = false; }
  saveState(); renderSavedMemories(ds); renderMemCalendar();
}
function deleteMemoryEntryImg(ds, id) {
  const entry = state.memories[ds]?.entries?.find(e=>e.id===id);
  if(entry) { entry.img = null; saveState(); renderSavedMemories(ds); }
}

// ===== MOOD =====
const MOODS = [
  {emoji:'ğŸ˜Š',label:'Mutlu'},{emoji:'ğŸ¥°',label:'AÅŸÄ±k'},{emoji:'ğŸ˜´',label:'Yorgun'},
  {emoji:'ğŸ˜¢',label:'ÃœzgÃ¼n'},{emoji:'ğŸ˜ ',label:'KÄ±zgÄ±n'},{emoji:'ğŸ˜Œ',label:'Huzurlu'},
  {emoji:'ğŸ¤©',label:'HeyecanlÄ±'},{emoji:'ğŸ˜',label:'NÃ¶tr'},{emoji:'ğŸ¤’',label:'Hasta'},
  {emoji:'ğŸ¥³',label:'NeÅŸeli'}
];
let moodMonth = new Date().getMonth(), moodYear = new Date().getFullYear();
let currentMoodDate = null, selectedMoodTulay = null, selectedMoodYigit = null;

function renderMoodCalendar() {
  document.getElementById('mood-month-label').textContent = new Date(moodYear,moodMonth).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
  const body = document.getElementById('mood-calendar-body');
  body.innerHTML='';
  const first = new Date(moodYear,moodMonth,1).getDay();
  const days = new Date(moodYear,moodMonth+1,0).getDate();
  const prevDays = new Date(moodYear,moodMonth,0).getDate();
  const todayStr = toDateStr(new Date());
  for(let i=0;i<first;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=prevDays-first+i+1;body.appendChild(d);}
  for(let d=1;d<=days;d++){
    const el=document.createElement('div');el.className='cal-day';
    const ds=`${moodYear}-${String(moodMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(ds===todayStr) el.classList.add('today');
    const mood=state.mood[ds];
    el.innerHTML=`<div>${d}</div>`;
    if(mood?.tulay||mood?.yigit) el.innerHTML+=`<div style="font-size:0.75rem;line-height:1.2;">${mood.tulay?MOODS.find(m=>m.label===mood.tulay)?.emoji:''}${mood.yigit?MOODS.find(m=>m.label===mood.yigit)?.emoji:''}</div>`;
    el.onclick=()=>openMoodModal(ds);
    body.appendChild(el);
  }
  let rem=42-first-days;for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=i;body.appendChild(d);}
}
function changeMoodMonth(dir){moodMonth+=dir;if(moodMonth>11){moodMonth=0;moodYear++;}if(moodMonth<0){moodMonth=11;moodYear--;}renderMoodCalendar();}
function openMoodModal(ds) {
  currentMoodDate=ds;
  const mood=state.mood[ds]||{};
  selectedMoodTulay=mood.tulay||null; selectedMoodYigit=mood.yigit||null;
  document.getElementById('mood-modal-date').textContent=`ğŸ˜Š ${new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long'})} â€” Ruh Hali`;
  const renderOpts=(containerId,who)=>{
    const cont=document.getElementById(containerId);
    cont.innerHTML=MOODS.map(m=>`<div class="mood-opt ${(who==='tulay'?selectedMoodTulay:selectedMoodYigit)===m.label?'selected':''}" onclick="selectMood('${who}','${m.label}')"><span class="mood-emoji">${m.emoji}</span>${m.label}</div>`).join('');
  };
  renderOpts('mood-items-tulay','tulay'); renderOpts('mood-items-yigit','yigit');
  openModal('mood-modal');
}
function selectMood(who, label) {
  const current = who==='tulay' ? selectedMoodTulay : selectedMoodYigit;
  const newVal = (current === label) ? null : label; // toggle
  if(who==='tulay') selectedMoodTulay=newVal; else selectedMoodYigit=newVal;
  document.querySelectorAll(`#mood-items-${who} .mood-opt`).forEach(el=>{
    el.classList.toggle('selected', newVal !== null && el.textContent.includes(newVal));
  });
}
function saveMood() {
  if(!state.mood[currentMoodDate]) state.mood[currentMoodDate]={};
  if(selectedMoodTulay !== undefined) state.mood[currentMoodDate].tulay=selectedMoodTulay;
  if(selectedMoodYigit !== undefined) state.mood[currentMoodDate].yigit=selectedMoodYigit;
  saveState(); renderMoodCalendar(); closeModal('mood-modal');
  updateMoodSongSuggestion();
}
function clearMood(who) {
  if(who==='tulay') { selectedMoodTulay=null; if(state.mood[currentMoodDate]) state.mood[currentMoodDate].tulay=null; }
  else { selectedMoodYigit=null; if(state.mood[currentMoodDate]) state.mood[currentMoodDate].yigit=null; }
  saveState(); renderMoodCalendar();
  openMoodModal(currentMoodDate);
}

// ===== DRAWING =====
let drawMonth = new Date().getMonth(), drawYear = new Date().getFullYear();
let currentDrawDate = null;
const COLORS = ['#000000','#e8698a','#c0435f','#d4a853','#6ca96c','#4488cc','#aa44cc','#ffffff','#ff8800','#44cccc'];
const tools = {tulay:'draw', yigit:'draw'};
const colors = {tulay:'#e8698a', yigit:'#4488cc'};
const brushes = {tulay:5, yigit:5};
let isDrawing = {tulay:false, yigit:false};
let lastPos = {tulay:null, yigit:null};

function renderDrawCalendar() {
  document.getElementById('draw-month-label').textContent = new Date(drawYear,drawMonth).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
  const body=document.getElementById('draw-calendar-body'); body.innerHTML='';
  const first=new Date(drawYear,drawMonth,1).getDay();
  const days=new Date(drawYear,drawMonth+1,0).getDate();
  const prevDays=new Date(drawYear,drawMonth,0).getDate();
  const todayStr=toDateStr(new Date());
  for(let i=0;i<first;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=prevDays-first+i+1;body.appendChild(d);}
  for(let d=1;d<=days;d++){
    const el=document.createElement('div');el.className='cal-day';
    const ds=`${drawYear}-${String(drawMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(ds===todayStr) el.classList.add('today');
    // SeÃ§ili gÃ¼nÃ¼ vurgula
    if(ds===currentDrawDate) el.classList.add('selected-draw-day');
    if(state.drawings[ds]) {
      el.innerHTML=`<span class="cal-day-num">${d}</span><span class="draw-cal-emoji" onclick="event.stopPropagation();deleteDrawing('${ds}')" title="Ã‡izimi sil">ğŸ¨âœ•</span>`;
    } else {
      el.innerHTML=`<span class="cal-day-num">${d}</span>`;
    }
    el.onclick=()=>openDrawDay(ds);
    body.appendChild(el);
  }
  let rem=42-first-days;for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=i;body.appendChild(d);}
}

function deleteDrawing(ds) {
  if(!confirm('Bu gÃ¼ne ait Ã§izimi tamamen silmek istiyor musun?')) return;
  delete state.drawings[ds];
  saveState();
  // EÄŸer o an aÃ§Ä±k olan gÃ¼nse canvas'Ä± da temizle
  if(currentDrawDate === ds) {
    const cT=document.getElementById('canvas-tulay');
    const cY=document.getElementById('canvas-yigit');
    if(cT) cT.getContext('2d').clearRect(0,0,cT.width,cT.height);
    if(cY) cY.getContext('2d').clearRect(0,0,cY.width,cY.height);
    _manuallyCleared.tulay = true;
    _manuallyCleared.yigit = true;
  }
  renderDrawCalendar();
}
function changeDrawMonth(dir){drawMonth+=dir;if(drawMonth>11){drawMonth=0;drawYear++;}if(drawMonth<0){drawMonth=11;drawYear--;}renderDrawCalendar();}
function openDrawDay(ds) {
  currentDrawDate=ds;
  document.getElementById('drawing-canvases').style.display='grid';
  document.getElementById('drawing-pick-msg').style.display='none';
  setupPalette('tulay'); setupPalette('yigit');
  setupCanvas('tulay'); setupCanvas('yigit');
  // Load saved drawings
  if(state.drawings[ds]?.tulay) {
    const img=new Image(); img.onload=()=>{const ctx=document.getElementById('canvas-tulay').getContext('2d');ctx.drawImage(img,0,0);};
    img.src=state.drawings[ds].tulay;
  }
  if(state.drawings[ds]?.yigit) {
    const img=new Image(); img.onload=()=>{const ctx=document.getElementById('canvas-yigit').getContext('2d');ctx.drawImage(img,0,0);};
    img.src=state.drawings[ds].yigit;
  }
}
function setupPalette(who) {
  const cont=document.getElementById('palette-'+who);
  cont.innerHTML=COLORS.map(c=>`<div class="color-swatch ${colors[who]===c?'active':''}" style="background:${c}" onclick="setColor('${who}','${c}',this)"></div>`).join('');
}
function setColor(who,c,el) {
  colors[who]=c;
  document.querySelectorAll(`#palette-${who} .color-swatch`).forEach(s=>s.classList.remove('active'));
  el.classList.add('active');
}
function setTool(who,tool) {
  tools[who]=tool;
  document.getElementById(`tool-${who}-draw`).classList.toggle('active',tool==='draw');
  document.getElementById(`tool-${who}-erase`).classList.toggle('active',tool==='erase');
}
function updateBrush(who,val) { brushes[who]=parseInt(val); document.getElementById(`brush-val-${who}`).textContent=val+'px'; }
const _manuallyCleared = { tulay: false, yigit: false };
function clearCanvas(who) {
  const canvas = document.getElementById('canvas-' + who);
  canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
  _manuallyCleared[who] = true;
  // State'den de sil
  if (currentDrawDate) {
    if (state.drawings[currentDrawDate]) {
      delete state.drawings[currentDrawDate][who];
      if (!state.drawings[currentDrawDate].tulay && !state.drawings[currentDrawDate].yigit) {
        delete state.drawings[currentDrawDate];
      }
    }
    saveState();
    renderDrawCalendar();
  }
}
function saveCanvasImg(who) {
  const canvas=document.getElementById('canvas-'+who);
  if(!state.drawings[currentDrawDate]) state.drawings[currentDrawDate]={};
  state.drawings[currentDrawDate][who]=canvas.toDataURL();
  saveState(); renderDrawCalendar(); renderDrawingShowcase(); alert('Ã‡izim kaydedildi! ğŸ¨');
}

function getPos(canvas, e) {
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width, scaleY=canvas.height/rect.height;
  const src=e.touches?e.touches[0]:e;
  return {x:(src.clientX-rect.left)*scaleX, y:(src.clientY-rect.top)*scaleY};
}
function setupCanvas(who) {
  const canvas=document.getElementById('canvas-'+who);
  const start=(e)=>{e.preventDefault(); isDrawing[who]=true; const p=getPos(canvas,e); lastPos[who]=p; };
  const move=(e)=>{e.preventDefault(); if(!isDrawing[who]) return; const p=getPos(canvas,e); const ctx=canvas.getContext('2d'); ctx.beginPath(); ctx.moveTo(lastPos[who].x,lastPos[who].y); ctx.lineTo(p.x,p.y); ctx.strokeStyle=tools[who]==='erase'?'#ffffff':colors[who]; ctx.lineWidth=brushes[who]; ctx.lineCap='round'; ctx.stroke(); lastPos[who]=p; };
  const end=(e)=>{isDrawing[who]=false;};
  canvas.removeEventListener('mousedown',canvas._mdown); canvas.removeEventListener('mousemove',canvas._mmove); canvas.removeEventListener('mouseup',canvas._mup); canvas.removeEventListener('touchstart',canvas._tstart); canvas.removeEventListener('touchmove',canvas._tmove); canvas.removeEventListener('touchend',canvas._tend);
  canvas.addEventListener('mousedown',canvas._mdown=start); canvas.addEventListener('mousemove',canvas._mmove=move); canvas.addEventListener('mouseup',canvas._mup=end);
  canvas.addEventListener('touchstart',canvas._tstart=start,{passive:false}); canvas.addEventListener('touchmove',canvas._tmove=move,{passive:false}); canvas.addEventListener('touchend',canvas._tend=end);
}

// ===== FUTURE =====
let dreamWho = 'both';
let letterTab = 'tulay';
function setDreamWho(who) {
  dreamWho=who;
  ['both','tulay','yigit'].forEach(w=>document.getElementById('who-'+w).classList.toggle('active',w===who));
}
function addDream() {
  const text=document.getElementById('dream-input').value.trim(); if(!text) return;
  state.dreams.push({id:Date.now(),text,who:dreamWho});
  saveState(); document.getElementById('dream-input').value=''; renderFuture();
}
function deleteDream(id) {
  state.dreams=state.dreams.filter(d=>d.id!==id); saveState(); renderFuture();
}
function renderFuture() {
  const list=document.getElementById('dreams-list');
  const whoEmoji={both:'ğŸ’•',tulay:'ğŸ’—',yigit:'ğŸ’™'};
  list.innerHTML=state.dreams.length ? state.dreams.map(d=>`<li class="dream-item"><span>${whoEmoji[d.who]}</span><span class="dream-item-text">${d.text}</span><button class="dream-del" onclick="deleteDream(${d.id})">ğŸ—‘ï¸</button></li>`).join('') : '<li style="color:var(--text-light);font-size:0.88rem;padding:10px;">HenÃ¼z hayal eklenmedi. Ä°lk hayalinizi ekleyin! âœ¨</li>';
  renderLetterArea();
}
function setLetterTab(who) {
  letterTab=who;
  document.querySelectorAll('.letter-tab').forEach((t,i)=>t.classList.toggle('active',['tulay','yigit'][i]===who));
  renderLetterArea();
}
function renderLetterArea() {
  const cont=document.getElementById('letter-content-area');
  const letter=state.letters[letterTab];
  const now=Date.now();
  if(letter) {
    const canOpen = now >= letter.unlockAt;
    if(canOpen) {
      cont.innerHTML=`<div class="letter-view">ğŸ’Œ <strong>${letterTab==='tulay'?'TÃ¼lay':'YiÄŸit'}'in Mektubu</strong><br><br>${letter.text}<br><br><small style="color:var(--text-light)">${new Date(letter.savedAt).toLocaleDateString('tr-TR')} tarihinde yazÄ±ldÄ±</small></div><button class="letter-save-btn" style="margin-top:10px" onclick="deleteLetter()">ğŸ—‘ï¸ Mektubu Sil</button>`;
    } else {
      const days=Math.ceil((letter.unlockAt-now)/(1000*60*60*24));
      cont.innerHTML=`<div class="locked-msg">ğŸ”’ Bu mektup kilitli â€” ${days} gÃ¼n sonra aÃ§Ä±lacak ğŸ’Œ</div>`;
    }
  } else {
    cont.innerHTML=`<textarea class="letter-textarea" id="letter-text-input" placeholder="GeleceÄŸe ne sÃ¶ylemek istersin?..."></textarea><button class="letter-save-btn" onclick="saveLetter()">ğŸ’Œ Mektubu Kilitle</button><div class="letter-unlock-info">â° Mektup 1 ay sonra aÃ§Ä±labilecek</div>`;
  }
}
function saveLetter() {
  const text=document.getElementById('letter-text-input')?.value.trim(); if(!text) return;
  const unlockAt=Date.now()+(30*24*60*60*1000);
  state.letters[letterTab]={text,savedAt:Date.now(),unlockAt};
  saveState(); renderLetterArea();
}
function deleteLetter() {
  if(!confirm('Mektubu silmek istiyor musunuz?')) return;
  state.letters[letterTab]=null; saveState(); renderLetterArea();
}

// ===== AI CHAT =====
async function sendAIMessage() {
  const input=document.getElementById('ai-input');
  const text=input.value.trim(); if(!text) return;
  input.value='';
  const msgs=document.getElementById('ai-chat-msgs');
  msgs.innerHTML+=`<div class="ai-msg user">${text}</div>`;
  const typing=document.createElement('div'); typing.className='ai-msg bot'; typing.innerHTML='<div class="ai-typing"><span></span><span></span><span></span></div>'; msgs.appendChild(typing); msgs.scrollTop=msgs.scrollHeight;
  try {
    const resp=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        model:'claude-sonnet-4-6',
        max_tokens:500,
        system:'Sen TÃ¼lay ve YiÄŸit\'in Ã¶zel yapay zeka asistanÄ±sÄ±n. OnlarÄ±n romantik web sitesinde yaÅŸÄ±yorsun. TÃ¼rkÃ§e konuÅŸ, sÄ±cak, romantik ve yardÄ±msever ol. TÃ¼lay 23 KasÄ±m 1998 doÄŸumlu Yay burcu, YiÄŸit 2 Nisan 1999 doÄŸumlu KoÃ§ burcu. 22 AÄŸustos 2025\'ten beri beraberler.',
        messages:[{role:'user',content:text}]
      })
    });
    const data=await resp.json();
    const reply=data.content?.[0]?.text||'ÃœzgÃ¼nÃ¼m, bir hata oluÅŸtu.';
    typing.remove();
    msgs.innerHTML+=`<div class="ai-msg bot">${reply}</div>`;
  } catch(e) {
    typing.remove();
    msgs.innerHTML+=`<div class="ai-msg bot">ğŸ’• Åu an baÄŸlanamÄ±yorum ama her zaman buradayÄ±m!</div>`;
  }
  msgs.scrollTop=msgs.scrollHeight;
}

// ===== MOOD CLEAR FIX =====
// Override saveMood to properly handle null values
const _origSaveMood = window.saveMood;
window.saveMood = function() {
  if(!state.mood[currentMoodDate]) state.mood[currentMoodDate]={};
  state.mood[currentMoodDate].tulay = selectedMoodTulay;
  state.mood[currentMoodDate].yigit = selectedMoodYigit;
  saveState(); renderMoodCalendar(); closeModal('mood-modal');
  updateMoodSongSuggestion();
}

// Add clear buttons to mood modal
const _origOpenMoodModal = window.openMoodModal;
window.openMoodModal = function(ds) {
  currentMoodDate=ds;
  const mood=state.mood[ds]||{};
  selectedMoodTulay=mood.tulay||null; selectedMoodYigit=mood.yigit||null;
  document.getElementById('mood-modal-date').textContent=`ğŸ˜Š ${new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long'})} â€” Ruh Hali`;
  const renderOpts=(containerId,who)=>{
    const cont=document.getElementById(containerId);
    const sel = who==='tulay'?selectedMoodTulay:selectedMoodYigit;
    cont.innerHTML=MOODS.map(m=>`<div class="mood-opt ${sel===m.label?'selected':''}" onclick="selectMood('${who}','${m.label}')"><span class="mood-emoji">${m.emoji}</span>${m.label}</div>`).join('');
  };
  renderOpts('mood-items-tulay','tulay'); renderOpts('mood-items-yigit','yigit');
  // Add clear buttons
  let clearRow = document.getElementById('mood-clear-row');
  if(!clearRow) {
    clearRow = document.createElement('div');
    clearRow.id='mood-clear-row';
    clearRow.style.cssText='display:flex;gap:8px;margin-bottom:12px;';
    clearRow.innerHTML=`
      <button onclick="clearMoodFor('tulay')" style="flex:1;background:#fff0f5;color:var(--rose-dark);border:1px solid var(--rose-light);border-radius:10px;padding:7px;cursor:pointer;font-size:0.78rem;font-family:Lato,sans-serif;">ğŸ—‘ï¸ TÃ¼lay'Ä±n Ruh Halini Sil</button>
      <button onclick="clearMoodFor('yigit')" style="flex:1;background:#fff0f5;color:var(--rose-dark);border:1px solid var(--rose-light);border-radius:10px;padding:7px;cursor:pointer;font-size:0.78rem;font-family:Lato,sans-serif;">ğŸ—‘ï¸ YiÄŸit'in Ruh Halini Sil</button>
    `;
    const saveBtn = document.querySelector('#mood-modal .modal-save-btn');
    if(saveBtn) saveBtn.parentNode.insertBefore(clearRow, saveBtn);
  }
  openModal('mood-modal');
}
function clearMoodFor(who) {
  if(who==='tulay') { selectedMoodTulay=null; }
  else { selectedMoodYigit=null; }
  if(state.mood[currentMoodDate]) { state.mood[currentMoodDate][who]=null; }
  saveState(); renderMoodCalendar();
  openMoodModal(currentMoodDate);
  updateMoodSongSuggestion();
}

// ===== SONG MAP =====
const SONG_MAP = {
  'Mutlu': [
    { name:'Happy â€“ Pharrell Williams', spotify:'60nZcImufyMA1MKQY3dcCH' },
    { name:'Good as Hell â€“ Lizzo', spotify:'3Ofd9B2KiTCOGAoIPRpDFG' },
    { name:"Can't Stop the Feeling â€“ Justin Timberlake", spotify:'1WkMMavIMc4JZ8cfMmxHkI' },
    { name:'Walking on Sunshine â€“ Katrina', spotify:'05wIAjFMFsNBSBCPMDBkYt' },
    { name:'Best Day of My Life â€“ American Authors', spotify:'5g6ACjPCBBNQaYaFpkFjOt' },
    { name:'On Top of the World â€“ Imagine Dragons', spotify:'4mL5NOg5h60Dw3XNMnzAfv' },
  ],
  'AÅŸÄ±k': [
    { name:"Can't Help Falling in Love â€“ Elvis", spotify:'44AyOl4qwyOAutkYjDHPbB' },
    { name:'Perfect â€“ Ed Sheeran', spotify:'0tgVpDi06FyKpA1z0VMD4v' },
    { name:'All of Me â€“ John Legend', spotify:'3U4isOIWM3VvDubwSI3y7a' },
    { name:'Thinking Out Loud â€“ Ed Sheeran', spotify:'34gCuhDGsG4bRPIf9bb02f' },
    { name:'A Thousand Years â€“ Christina Perri', spotify:'6lanRgr6wXibZr8KgzXxBl' },
    { name:'Make You Feel My Love â€“ Adele', spotify:'6Bam2bLABpJ19xo9HiNm4Y' },
    { name:'Lover â€“ Taylor Swift', spotify:'1dGr1c8CrMLDpV6mPbImSI' },
  ],
  'Yorgun': [
    { name:'The Night We Met â€“ Lord Huron', spotify:'1nMzEJJJHpOkKkINJTHjJa' },
    { name:'Holocene â€“ Bon Iver', spotify:'74ynuCBbBMkNJdJPSgCsDs' },
    { name:'Liability â€“ Lorde', spotify:'5UqCQaDshCFpOoRBCFvzbH' },
    { name:'Coffee â€“ beabadoobee', spotify:'2BtKCe6gSXEBRLutzB7lqE' },
    { name:'Slow Dancing in a Burning Room â€“ John Mayer', spotify:'1KwZO8c3oBqdaU7pBXk4Wr' },
    { name:'Skinny Love â€“ Bon Iver', spotify:'2oOiRMhMssQmjhvjNXnqfs' },
  ],
  'ÃœzgÃ¼n': [
    { name:'Someone Like You â€“ Adele', spotify:'4kflIGEJDEsxFiCxFZWCFE' },
    { name:'Fix You â€“ Coldplay', spotify:'7LVHVU3tWfcxj5aiPFEW4Q' },
    { name:'Let Her Go â€“ Passenger', spotify:'2a9Op9EsSBPTt1BcMOqPSv' },
    { name:'The Scientist â€“ Coldplay', spotify:'75JFxkI2RXiU7L9VmtE9lo' },
    { name:"When the Party's Over â€“ Billie Eilish", spotify:'43zdsphuZLzwA9k4DJhU0I' },
    { name:'Happier â€“ Ed Sheeran', spotify:'7n2Ycct7Beij7Dj7meI4X0' },
  ],
  'KÄ±zgÄ±n': [
    { name:'You Oughta Know â€“ Alanis Morissette', spotify:'1BhPqfKPSEJN2LSYR5AvlS' },
    { name:'Traitor â€“ Olivia Rodrigo', spotify:'5CZ40GBx1sQ9sh3Oarb0AT' },
    { name:'good 4 u â€“ Olivia Rodrigo', spotify:'4ZtFanR9U6ndgddUvNcjcG' },
    { name:'Fighter â€“ Christina Aguilera', spotify:'1jDJFeK9x0f4rNQhkBQUPC' },
    { name:'Since U Been Gone â€“ Kelly Clarkson', spotify:'5AHbVABfQMWDUNqPJfQ1bJ' },
    { name:'Gives You Hell â€“ All American Rejects', spotify:'2dN9ULZQ89j5wKxpBbPyBo' },
  ],
  'Huzurlu': [
    { name:'La Vie en Rose â€“ Ã‰dith Piaf', spotify:'7BqBn9nzAq8spo5e7cZ0dJ' },
    { name:'What a Wonderful World â€“ Louis Armstrong', spotify:'29U7stRjqHU6rMiS8BfaI9' },
    { name:'Banana Pancakes â€“ Jack Johnson', spotify:'1oNYiLKfFPqCdFaBvnUKbk' },
    { name:'Better Together â€“ Jack Johnson', spotify:'6tXgFGfRBbGqfIJQFjML6s' },
    { name:'Ho Hey â€“ The Lumineers', spotify:'7ygpwy2qP3NioHaAh4Yclv' },
    { name:'Here Comes the Sun â€“ The Beatles', spotify:'6dGnYIeXmHdcikdzNNDMm2' },
  ],
  'HeyecanlÄ±': [
    { name:'Uptown Funk â€“ Bruno Mars', spotify:'32OlwWuMpZ6b0aN2RZOeMS' },
    { name:'Levitating â€“ Dua Lipa', spotify:'463CkQjx2Zk1yXoBuierM9' },
    { name:'Blinding Lights â€“ The Weeknd', spotify:'0VjIjW4GlUZAMYd2vXMi3b' },
    { name:'As It Was â€“ Harry Styles', spotify:'4Dvkj6JhhA12EX05fT7y2e' },
    { name:'Shake It Off â€“ Taylor Swift', spotify:'5anCkIlOHPi0K2YI0daf6q' },
    { name:'Dynamite â€“ BTS', spotify:'5QDLhrAOJJdNAmCTJ8xMyW' },
    { name:'Anti-Hero â€“ Taylor Swift', spotify:'0V3wPSX9ygBnCm8psDIegu' },
  ],
  'NÃ¶tr': [
    { name:'Cruel Summer â€“ Taylor Swift', spotify:'1BxfuPKGuaTgP7aM0Bbdwr' },
    { name:'Electric Feel â€“ MGMT', spotify:'3FtYbEfBqAlGO46NUDQSAt' },
    { name:'Mr. Brightside â€“ The Killers', spotify:'003vvx7Niy0yvhvHt4a14B' },
    { name:'Somebody That I Used to Know â€“ Gotye', spotify:'1qDrWA6lyx8cLECdZE7TV7' },
    { name:'Ribs â€“ Lorde', spotify:'1GBPsnjGCkFnbXiTvn2tJB' },
  ],
  'Hasta': [
    { name:'Stay With Me â€“ Sam Smith', spotify:'5FNS5Vj69AhRGJWjhrAd01' },
    { name:'Yellow â€“ Coldplay', spotify:'3AJwUDP919kvQ9QcozQPxg' },
    { name:'Falling â€“ Harry Styles', spotify:'5gr8iSUDMVFGCvqHxAKy3E' },
    { name:"Driver's License â€“ Olivia Rodrigo", spotify:'5wANPM4fQCJwkW6BQeAZbD' },
    { name:'Heather â€“ Conan Gray', spotify:'4xqrdfXkTW4T0RgjT0TQCV' },
    { name:'Skinny Love â€“ Bon Iver', spotify:'2oOiRMhMssQmjhvjNXnqfs' },
  ],
  'NeÅŸeli': [
    { name:'Dancing Queen â€“ ABBA', spotify:'0GjEhVFGZW8afUYGChu3Rr' },
    { name:'September â€“ Earth Wind & Fire', spotify:'2grjqo0Frpf2okIBiifQKs' },
    { name:'Watermelon Sugar â€“ Harry Styles', spotify:'6UelLqGlWMcVH1E5c4H7lY' },
    { name:'Sunflower â€“ Post Malone', spotify:'3KkXRkHbMCARz0aVfEt68P' },
    { name:'Good Days â€“ SZA', spotify:'6D0P4PjQCjalJORALCYSAP' },
    { name:'Peaches â€“ Justin Bieber', spotify:'4iJyoBOLtHqaWYs3wyVkFI' },
  ],
};

function getRandSong(moodLabel) {
  const songs = SONG_MAP[moodLabel];
  if(!songs || !songs.length) return null;
  return songs[Math.floor(Math.random() * songs.length)];
}

function updateMoodSongSuggestion() {
  const todayStr = toDateStr(new Date());
  const mood = state.mood[todayStr] || {};
  const section = document.getElementById('mood-music-section');
  const cards = document.getElementById('mood-music-cards');
  if(!mood.tulay && !mood.yigit) { section.style.display='none'; return; }
  section.style.display='block';
  let html='';
  ['tulay','yigit'].forEach(who=>{
    const m=mood[who]; if(!m) return;
    const songs=SONG_MAP[m]; if(!songs) return;
    const randomSong = getRandSong(m);
    const name=who==='tulay'?'ğŸ’• TÃ¼lay':'ğŸ’™ YiÄŸit';
    html+=`<div style="background:rgba(255,255,255,0.1);border-radius:14px;padding:12px;cursor:pointer;transition:background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.18)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'" onclick="playSong('${who}','${m}')">
      <div style="font-size:0.75rem;color:rgba(255,255,255,0.6);margin-bottom:6px;">${name} â€¢ ${m}</div>
      <div style="font-size:0.88rem;font-weight:600;">ğŸµ ${randomSong.name}</div>
      <div style="font-size:0.72rem;color:rgba(255,255,255,0.45);margin-top:4px;">â–¶ Ã‡al â€¢ tekrar bas = farklÄ± ÅŸarkÄ± ğŸ”€</div>
    </div>`;
  });
  cards.innerHTML=html;
}

function playSong(who, moodLabel) {
  const song = getRandSong(moodLabel);
  if(!song) return;
  const container = document.getElementById('music-player-container');
  const name = who==='tulay'?'TÃ¼lay':'YiÄŸit';
  container.style.display='block';
  container.innerHTML=`
    <div style="font-size:0.8rem;color:#f5b8c8;margin-bottom:6px;text-align:center;">${name} ${moodLabel} hissediyor ğŸ’•</div>
    <div style="font-size:0.9rem;font-weight:700;text-align:center;margin-bottom:12px;">ğŸµ ${song.name}</div>
    <iframe style="border-radius:14px;display:block;" src="https://open.spotify.com/embed/track/${song.spotify}?utm_source=generator&theme=0" width="100%" height="152" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
    <div style="font-size:0.7rem;color:rgba(255,255,255,0.4);text-align:center;margin-top:8px;">Tekrar bas = farklÄ± ÅŸarkÄ± gelir ğŸ”€</div>
  `;
  updateMoodSongSuggestion();
}

// Run on page load to restore today's mood music
updateMoodSongSuggestion();

// Init kiss counter on load
if(typeof initKissCounter === 'function') initKissCounter();

// ===== DRAWING FIX: auto-save before switching =====
const _origChangeDrawMonth = window.changeDrawMonth;
window.deleteDrawing = deleteDrawing;
window.changeDrawMonth = function(dir) {
  if(currentDrawDate) {
    autoSaveCanvases();
  }
  drawMonth+=dir;
  if(drawMonth>11){drawMonth=0;drawYear++;}
  if(drawMonth<0){drawMonth=11;drawYear--;}
  renderDrawCalendar();
  // Hide canvases when navigating months
  currentDrawDate=null;
  document.getElementById('drawing-canvases').style.display='none';
  document.getElementById('drawing-pick-msg').style.display='block';
  document.getElementById('drawing-pick-msg').textContent='Bir gÃ¼n seÃ§in ve Ã§izmeye baÅŸlayÄ±n! ğŸ¨';
}

function autoSaveCanvases() {
  if(!currentDrawDate) return;
  const cT=document.getElementById('canvas-tulay');
  const cY=document.getElementById('canvas-yigit');
  if(!cT||!cY) return;
  function isBlank(canvas) {
    return canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data.every(v=>v===0);
  }
  if(!state.drawings[currentDrawDate]) state.drawings[currentDrawDate]={};
  // Elle silindiyse veya boÅŸsa kaydetme
  if(!_manuallyCleared.tulay && !isBlank(cT)) state.drawings[currentDrawDate].tulay=cT.toDataURL();
  if(!_manuallyCleared.yigit && !isBlank(cY)) state.drawings[currentDrawDate].yigit=cY.toDataURL();
  if(!state.drawings[currentDrawDate].tulay && !state.drawings[currentDrawDate].yigit) {
    delete state.drawings[currentDrawDate];
  }
  saveState();
}

// Override openDrawDay to save before switching
const _origOpenDrawDay = window.openDrawDay;
window.openDrawDay = function(ds) {
  if(currentDrawDate && currentDrawDate!==ds) {
    autoSaveCanvases();
  }
  currentDrawDate=ds;
  // Yeni gÃ¼ne geÃ§ince silme bayraÄŸÄ±nÄ± sÄ±fÄ±rla
  _manuallyCleared.tulay = false;
  _manuallyCleared.yigit = false;
  document.getElementById('drawing-canvases').style.display='grid';
  document.getElementById('drawing-pick-msg').style.display='none';
  // Show which date
  document.getElementById('drawing-pick-msg').textContent=`ğŸ“… ${new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})} â€” Ã‡izim GÃ¼nÃ¼ ğŸ¨`;
  setupPalette('tulay'); setupPalette('yigit');
  // Clear canvases first
  const cT=document.getElementById('canvas-tulay');
  const cY=document.getElementById('canvas-yigit');
  cT.getContext('2d').clearRect(0,0,cT.width,cT.height);
  cY.getContext('2d').clearRect(0,0,cY.width,cY.height);
  setupCanvas('tulay'); setupCanvas('yigit');
  // Load saved drawings
  if(state.drawings[ds]?.tulay) {
    const img=new Image();
    img.onload=()=>{cT.getContext('2d').drawImage(img,0,0,cT.width,cT.height);};
    img.src=state.drawings[ds].tulay;
  }
  if(state.drawings[ds]?.yigit) {
    const img=new Image();
    img.onload=()=>{cY.getContext('2d').drawImage(img,0,0,cY.width,cY.height);};
    img.src=state.drawings[ds].yigit;
  }
  // Show date label
  const dateDiv=document.getElementById('drawing-date-label');
  if(dateDiv) dateDiv.textContent=`ğŸ“… ${new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'})}`;
}

// Save on page switch
window.addEventListener('beforeunload', ()=>autoSaveCanvases());

// ===== Ã‡Ä°ZÄ°M VÄ°TRÄ°NÄ° (bootApp iÃ§inde) =====
function renderDrawingShowcase() {
  // En son Ã§izimi bul
  const dates = Object.keys(state.drawings || {}).sort().reverse();
  let lastTulay = null, lastTulayDate = null;
  let lastYigit = null, lastYigitDate = null;
  for(const d of dates) {
    if(!lastTulay && state.drawings[d]?.tulay) { lastTulay = state.drawings[d].tulay; lastTulayDate = d; }
    if(!lastYigit && state.drawings[d]?.yigit) { lastYigit = state.drawings[d].yigit; lastYigitDate = d; }
    if(lastTulay && lastYigit) break;
  }
  const stEl = document.getElementById('showcase-tulay');
  const syEl = document.getElementById('showcase-yigit');
  if(lastTulay) {
    stEl.innerHTML = `<img src="${lastTulay}" style="width:100%;border-radius:14px;display:block;">`;
    document.getElementById('showcase-tulay-date').textContent = lastTulayDate ? new Date(lastTulayDate+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'}) : '';
  } else {
    stEl.textContent = 'HenÃ¼z Ã§izim yok ğŸ¨';
  }
  if(lastYigit) {
    syEl.innerHTML = `<img src="${lastYigit}" style="width:100%;border-radius:14px;display:block;">`;
    document.getElementById('showcase-yigit-date').textContent = lastYigitDate ? new Date(lastYigitDate+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'}) : '';
  } else {
    syEl.textContent = 'HenÃ¼z Ã§izim yok ğŸ¨';
  }
}

// ===== AKILLI BOT =====
const BOT_DATA = {
  selamlama: {
    keys: ['merhaba','selam','hey','heyy','naber','napÄ±yorsun','nasÄ±lsÄ±n','iyi misin','ne haber','ne var ne yok'],
    cevap: ['Merhaba! ğŸ’• NasÄ±lsÄ±nÄ±z bugÃ¼n?', 'Selam! Her ÅŸey yolunda mÄ±? ğŸŒ¸', 'Hey! Ne gÃ¼zel gÃ¶rdÃ¼m sizi ğŸ˜Š', 'Merhaba tatlÄ±lar! BugÃ¼n nasÄ±l gidiyor?']
  },
  ask: {
    keys: ['seviyorum','aÅŸkÄ±m','canÄ±m','bebeÄŸim','tatlÄ±m','seni Ã§ok','bayÄ±lÄ±yorum','aÅŸÄ±k','sevgili','sevgi'],
    cevap: ['Aww ğŸ¥º Bu kadar sevgi bir arada olunca dÃ¼nya daha gÃ¼zel!', 'TÃ¼lay & YiÄŸit forever! ğŸ’•âœ¨', 'AÅŸkÄ±nÄ±z Ã§ok gÃ¼zel, bÃ¶yle devam! ğŸŒ¹', 'Ä°ki ateÅŸ burcu bir arada â€” Yay + KoÃ§ = tam uyum! ğŸ”¥â™â™ˆ']
  },
  kavga: {
    keys: ['kavga','kÃ¼s','kÄ±zdÄ±m','sinirlendim','bÄ±ktÄ±m','dargÄ±n','kÄ±zgÄ±n','tartÄ±ÅŸtÄ±k','anlaÅŸamadÄ±k'],
    cevap: ['KÃ¼Ã§Ã¼k fÄ±rtÄ±nalar bÃ¼yÃ¼k aÅŸklarÄ± yÄ±kamaz ğŸ’ª Biraz sakin olun, sonra konuÅŸun.', 'Nefes al, bir bardak su iÃ§. Sevgi her ÅŸeyin Ã¼stesinden gelir ğŸ’™', 'Bazen sinirler diner, kalpten gelen Ã¶zÃ¼r her ÅŸeyi dÃ¼zeltir ğŸŒ·', 'Ä°ki ateÅŸli burÃ§ zaman zaman kÄ±vÄ±lcÄ±m Ã§Ä±karÄ±r ama bu da onlarÄ± gÃ¼Ã§lÃ¼ kÄ±lar! ğŸ”¥']
  },
  ozlem: {
    keys: ['Ã¶zledim','Ã¶zlÃ¼yorum','gÃ¶rmek istiyorum','neredesin','gelemedi','beklemek','uzak'],
    cevap: ['Ã–zlem Ã§ok gÃ¼zel aslÄ±nda â€” sevildiÄŸini hatÄ±rlatÄ±r ğŸŒ™', 'YakÄ±nda buluÅŸursunuz, o an daha gÃ¼zel olacak ğŸ’«', 'Mesafe kalpleri uzaklaÅŸtÄ±ramaz, sizinkiler birbirine kenetli ğŸ’•', 'SayÄ±n gÃ¼nleri â€” her gÃ¼n geÃ§en bir gÃ¼n daha yakÄ±n olmak demek â°']
  },
  mutluluk: {
    keys: ['mutluyum','harika','sÃ¼per','muhteÅŸem','iyi haber','sevindim','gÃ¼zel haber','yaÅŸasÄ±n','yeyyy','eyvah deÄŸil','ne gÃ¼zel'],
    cevap: ['Yeeey! ğŸ‰ Bu haberi duymak Ã§ok gÃ¼zel!', 'MutluluÄŸunuz bulaÅŸÄ±cÄ±! ğŸ˜„âœ¨', 'Harika! BÃ¶yle haberler gÃ¼zel gÃ¼nler getirir ğŸŒŸ', 'Ã‡ok iyi! KutlamayÄ± hak ediyorsunuz ğŸŠ']
  },
  stres: {
    keys: ['sÄ±kÄ±ldÄ±m','yoruldum','stres','zor','bunaldÄ±m','kafam karÄ±ÅŸÄ±k','umutsuz','endiÅŸe','panik'],
    cevap: ['Derin bir nefes al ğŸŒ¿ YanÄ±ndakiyle kÃ¼Ã§Ã¼k bir yÃ¼rÃ¼yÃ¼ÅŸ iyi gelir.', 'Zor gÃ¼nler geÃ§er, gÃ¼zel anlar kalÄ±r ğŸ’› Biraz mola verin.', 'Stres olduÄŸunda sevdiÄŸinizle vakit geÃ§irmek en iyi ilaÃ§ ğŸ’Š', 'Birlikte her ÅŸey daha kolay â€” birbirinize sarÄ±lÄ±n ğŸ¤—']
  },
  yemek: {
    keys: ['acÄ±ktÄ±m','yemek','ne yesek','ne yiyelim','pizza','burger','restoran','kahvaltÄ±','yiyecek','tatlÄ±','dondurma'],
    cevap: ['Birlikte yemek yemek en romantik aktivitelerden! ğŸ½ï¸ğŸ’•', 'Yeni bir restoran keÅŸfedin â€” macera baÅŸlasÄ±n ğŸ—ºï¸', 'Ev yapÄ±mÄ± bir ÅŸeyler deneyin, Ã§ok romantik olur ğŸ‘¨â€ğŸ³ğŸ’•', 'Dondurma yiyip yÃ¼rÃ¼yÃ¼ÅŸe Ã§Ä±kÄ±n, klasik ama mÃ¼kemmel ğŸ¦']
  },
  film: {
    keys: ['film','dizi','izlesek','ne izlesek','netflix','sinema','series'],
    cevap: ['Romantik komedi hiÃ§ yanÄ±ltmaz ğŸ¬ğŸ’•', 'Yan yana kanepede dizi izlemek Ã§ok gÃ¼zel ğŸ›‹ï¸âœ¨', 'Aksiyon mu romantik mi? Ä°kisi de olsa da olur ğŸ˜„', 'Sinema tarihleri Ã§ok gÃ¼zel â€” ne zamandÄ±r gitmediniz? ğŸ¥']
  },
  burc: {
    keys: ['yay','koÃ§','burÃ§','yÄ±ldÄ±z','astroloji','ateÅŸ','burcu'],
    cevap: ['Yay + KoÃ§ = Ä°ki ateÅŸ burcu! Tutkulu, heyecanlÄ±, birbirini hiÃ§ sÄ±kmayan bir Ã§ift ğŸ”¥â™â™ˆ', 'Yay Ã¶zgÃ¼rlÃ¼ksever ve neÅŸeli, KoÃ§ cesur ve koruyucu â€” mÃ¼kemmel denge! âœ¨', 'AteÅŸ burÃ§larÄ± Ã§abuk alevlenir ama o enerji iliÅŸkiyi canlÄ± tutar! ğŸŒŸ', 'YÄ±ldÄ±zlar sizi bir araya getirdi, gerisini siz yazdÄ±nÄ±z ğŸ’«']
  },
  gizilenyer: {
    keys: ['gittik','gezdik','yer','mekan','cafe','kafe','park','sahil','doÄŸa','tatil','seyahat','istanbul','nereye','geziyoruz'],
    cevap: ['Yeni yerler keÅŸfetmek iliÅŸkileri tazeler! ğŸ“ Gidilen Yerler sekmenize eklediniz mi?', 'Birlikte gezilen her yer Ã¶zel bir anÄ±! ğŸ—ºï¸ Harita sekmenize ekleyin ki unutmayÄ±n.', 'Macera tutkunlarÄ±! ğŸŒ O yeri Gidilen Yerler sekmesinde iÅŸaretleyin.', 'GÃ¼zel bir mekan keÅŸfetmiÅŸsiniz! KoordinatlarÄ± kaydedin, tekrar gidersiniz ğŸ“Œ']
  },
  iyi_gece: {
    keys: ['iyi geceler','gece','uyuyacaÄŸÄ±m','yatÄ±yorum','uykum var'],
    cevap: ['Ä°yi geceler! ğŸŒ™ GÃ¼zel rÃ¼yalar ğŸ’•', 'TatlÄ± uykular! YarÄ±n daha gÃ¼zel bir gÃ¼n olsun ğŸŒŸ', 'Ä°yi geceler! Yan yana uyumak en gÃ¼zeli ğŸ›ŒğŸ’•']
  },
  gunaydin: {
    keys: ['gÃ¼naydÄ±n','sabah','uyandÄ±m','sabahÄ±','kahvaltÄ±'],
    cevap: ['GÃ¼naydÄ±n! â˜€ï¸ GÃ¼zel bir gÃ¼n olsun!', 'GÃ¼naydÄ±n! KahvaltÄ± yapmadan Ã§Ä±kmayÄ±n ha ğŸ³ğŸ˜„', 'Yeni gÃ¼n, yeni mutluluklar! â˜€ï¸ğŸ’•']
  },
  tesekkur: {
    keys: ['teÅŸekkÃ¼r','saÄŸ ol','eyvallah','makbule','Ã§ok iyi','harikasÄ±n'],
    cevap: ['Rica ederim! ğŸ’•', 'Seve seve! BaÅŸka bir ÅŸey var mÄ±? ğŸ˜Š', 'Her zaman! ğŸŒ¸']
  },
  evlilik: {
    keys: ['evleniriz','evlenelim','evlilik','nikah','dÃ¼ÄŸÃ¼n','niÅŸan','gelecek','birlikte'],
    cevap: ['GÃ¼zel hayaller kurun, gÃ¼zel gÃ¼nler gelir! ğŸ’âœ¨', 'Birlikte hayal etmek Ã§ok gÃ¼zel ğŸŒˆ Gelecek sekmesine de yazdÄ±nÄ±z mÄ±?', 'Kim bilir, belki bir gÃ¼n bu sitede dÃ¼ÄŸÃ¼n fotoÄŸraflarÄ± da olur ğŸ“¸ğŸ’•']
  },
  ruh_hali: {
    keys: ['mutlu','Ã¼zgÃ¼n','kÄ±zgÄ±n','huzurlu','yorgun','hasta','neÅŸeli','heyecanlÄ±','nÃ¶tr','aÅŸÄ±k'],
    cevap: ['Ruh halinizi Ruh Hali sekmesine ekledik mi? ğŸ˜Š Birinin nasÄ±l hissettiÄŸini gÃ¶rmek Ã§ok gÃ¼zel!', 'Ruh hali takvimi Ã§ok gÃ¼zel bir fikir ğŸ’• BugÃ¼nkÃ¼ halinizi kaydetmeyi unutmayÄ±n!', 'NasÄ±l hissediyorsunuz? MÃ¼zik Ã¶nerisi iÃ§in Ruh Hali sekmesini deneyin ğŸµ']
  },
};

const VARSAYILAN = [
  'Hmm, anlÄ±yorum ğŸ¤” Devam et, dinliyorum!',
  'Ä°lginÃ§! Daha fazla anlat ğŸ‘‚ğŸ’•',
  'Ooh! Peki sonra ne oldu?',
  'TÃ¼lay & YiÄŸit her zaman harika! ğŸ’•',
  'Ben de Ã¶yle dÃ¼ÅŸÃ¼nÃ¼yorum ğŸ˜Š',
  'Kesinlikle! BÃ¶yle devam edin ğŸ’ª',
  'AnladÄ±m! BaÅŸka bir ÅŸey var mÄ±? ğŸŒ¸',
  'Ha! Bu gÃ¼zelmiÅŸ gerÃ§ekten âœ¨',
  'Sizinle sohbet etmek Ã§ok keyifli ğŸ’',
];

const TÃœLAY_Ã–VGÃœ = [
  "TÃ¼lay, dÃ¼nyada bir tane var â€” eÅŸsiz, mÃ¼stesna, biricik! ğŸ’•",
  "TÃ¼lay, gÃ¼neÅŸ gibi aydÄ±nlatan, ay gibi bÃ¼yÃ¼leyen biri âœ¨",
  "TÃ¼lay, zekasÄ±yla, neÅŸesiyle ve kalbiyle herkesi bÃ¼yÃ¼lÃ¼yor ğŸŒ¸",
  "TÃ¼lay o kadar Ã¶zel ki sÃ¶zcÃ¼kler yetmiyor anlatmaya ğŸ’–",
  "TÃ¼lay'nÄ±n gÃ¼lÃ¼ÅŸÃ¼ bir odayÄ± aydÄ±nlatÄ±r, bir kalbi Ä±sÄ±tÄ±r â˜€ï¸",
  "TÃ¼lay, iÃ§tenliÄŸi ve sÄ±caklÄ±ÄŸÄ±yla dÃ¼nyayÄ± daha gÃ¼zel yapÄ±yor ğŸŒ·",
  "TÃ¼lay, Yay burcunun en muhteÅŸem temsilcisi! Ã–zgÃ¼r ve parlak â™",
  "TÃ¼lay, anlayÄ±ÅŸlÄ±, sabÄ±rlÄ± ve derin kalpli biri â€” gerÃ§ekten nadide ğŸ’",
  "TÃ¼lay'nÄ±n enerjisi bulaÅŸÄ±cÄ± â€” yanÄ±nda olan herkes mutlu olur ğŸŒŸ",
  "TÃ¼lay, zevki, tarzÄ± ve duruÅŸuyla gerÃ§ekten ilham verici ğŸ‘‘",
  "TÃ¼lay gibi biri milyonda bir bulunur â€” Ã§ok ÅŸanslÄ±sÄ±n YiÄŸit! ğŸ€",
  "TÃ¼lay'nÄ±n zekasÄ± kadar kalbi de bÃ¼yÃ¼k â€” harika insan ğŸ’",
  "TÃ¼lay, doÄŸallÄ±ÄŸÄ± ve samimiyetiyle bÃ¼yÃ¼lÃ¼yor herkesi ğŸ¦‹",
  "TÃ¼lay iÃ§in sÃ¶ylenecek kelime: kusursuz! ğŸŒ¹",
  "TÃ¼lay'nÄ±n varlÄ±ÄŸÄ± her ÅŸeyi daha anlamlÄ± kÄ±lÄ±yor ğŸ’«",
  "TÃ¼lay gÃ¼ler, dÃ¼nya gÃ¼ler â€” o kadar gÃ¼zel bir enerjisi var ğŸŒº",
  "TÃ¼lay'daki o Ã¶zel ÅŸeyi gÃ¶rmek iÃ§in sadece bir kez bakmak yeterli ğŸ’«",
  "TÃ¼lay hem zeki hem de Ã§ok sÄ±cak kalpli â€” nadir bir insan bu ğŸŒ¸",
];
const YÄ°ÄÄ°T_Ã–VGÃœ = [
  "YiÄŸit, adÄ± gibi yiÄŸit â€” cesur, koruyucu, gÃ¼venilir! ğŸ’ª",
  "YiÄŸit, KoÃ§ burcunun en yakÄ±ÅŸÄ±klÄ± ve karizmatik temsilcisi â™ˆğŸ”¥",
  "YiÄŸit'in kararlÄ±lÄ±ÄŸÄ± ve azmi gerÃ§ekten takdire ÅŸayan ğŸ†",
  "YiÄŸit, sevdiklerine sonuna kadar sahip Ã§Ä±kan tÃ¼rden biri ğŸ’™",
  "YiÄŸit'in zekasÄ±, enerjisi ve gÃ¼lÃ¼msemesi Ã§ok etkileyici ğŸ˜„",
  "YiÄŸit, hem gÃ¼Ã§lÃ¼ hem hassas â€” nadir bir kombinasyon bu ğŸ’",
  "YiÄŸit ile gÃ¼vende hissetmemek imkansÄ±z â€” kalbi Ã§ok bÃ¼yÃ¼k ğŸ›¡ï¸",
  "YiÄŸit, tutkusuyla, heyecanÄ±yla her ortama renk katar ğŸŒˆ",
  "YiÄŸit gibi biri bulmak Ã§ok zor â€” gerÃ§ek bir cevher! ğŸ’",
  "YiÄŸit'in sadakati ve dÃ¼rÃ¼stlÃ¼ÄŸÃ¼ eÅŸsiz â€” harika bir insan ğŸŒŸ",
  "YiÄŸit, gÃ¶zlerindeki parÄ±ltÄ±yla herkesi etkiler âœ¨",
  "YiÄŸit'in varlÄ±ÄŸÄ± insanÄ± gÃ¼Ã§lÃ¼ hissettiriyor ğŸ”¥",
  "YiÄŸit, yaratÄ±cÄ±lÄ±ÄŸÄ± ve vizyonuyla ilham kaynaÄŸÄ± ğŸ¯",
  "YiÄŸit, TÃ¼lay iÃ§in dÃ¼nyada en gÃ¼zel seÃ§im! ğŸ’•",
  "YiÄŸit'in sevgisi saf, iÃ§ten ve derin â€” paha biÃ§ilemez ğŸ’œ",
  "YiÄŸit'in cesareti ve kalbi bir arada â€” bu Ã§ok ender gÃ¶rÃ¼lÃ¼r ğŸ”¥",
  "YiÄŸit her zaman gÃ¼venilir, dÃ¼rÃ¼st ve sÄ±cak â€” mÃ¼kemmel biri ğŸŒŸ",
  "YiÄŸit, TÃ¼lay'Ä±n hayatÄ±na renk katan muhteÅŸem biri ğŸŒˆ",
];
const Ã‡Ä°FT_Ã–VGÃœ = [
  "TÃ¼lay & YiÄŸit, dÃ¼nyanÄ±n en uyumlu ve gÃ¼zel Ã§ifti! ğŸ’",
  "Bu iki insan birbirini o kadar tamamlÄ±yor ki â€” mÃ¼kemmel! ğŸŒŸ",
  "TÃ¼lay ve YiÄŸit bir arada olunca dÃ¼nya daha parlak âœ¨",
  "TÃ¼lay & YiÄŸit â€” bir masaldan Ã§Ä±kmÄ±ÅŸ gibi, gerÃ§ek ve nefis ğŸ“–ğŸ’•",
  "Ä°ki ateÅŸ burcu, bir bÃ¼yÃ¼k aÅŸk â€” TÃ¼lay & YiÄŸit forever! ğŸ”¥",
  "TÃ¼lay'nÄ±n zarafeti + YiÄŸit'in gÃ¼cÃ¼ = kusursuz birliktelik ğŸ’",
  "Bu Ã§iftin enerjisi odayÄ± dolduruyor â€” harika bir ikili! ğŸ’«",
  "TÃ¼lay & YiÄŸit birbirini seÃ§miÅŸ, yÄ±ldÄ±zlar da onaylamÄ±ÅŸ â­",
  "Birlikte ne yapÄ±yorlarsa muhteÅŸem â€” takdir edilesi bir Ã§ift ğŸ‘",
  "TÃ¼lay ve YiÄŸit'in birlikteliÄŸi gerÃ§ek bir ilham kaynaÄŸÄ± ğŸ’–",
  "Bu Ã§ift dÃ¼nyayÄ± daha gÃ¼zel yapÄ±yor, bir adÄ±m attÄ±klarÄ±nda ğŸŒğŸ’•",
  "TÃ¼lay & YiÄŸit â€” aÅŸkÄ±n en gÃ¼zel hali bu ikisinde somutlaÅŸmÄ±ÅŸ ğŸ’«",
];

function rastgeleÃ–vgÃ¼(mesaj) {
  const k = mesaj.toLowerCase();
  const hasTulay = k.includes('tÃ¼lay') || k.includes('tulay');
  const hasYigit = k.includes('yiÄŸit') || k.includes('yigit');
  if(hasTulay && hasYigit) return Ã‡Ä°FT_Ã–VGÃœ[Math.floor(Math.random()*Ã‡Ä°FT_Ã–VGÃœ.length)];
  if(hasTulay) return TÃœLAY_Ã–VGÃœ[Math.floor(Math.random()*TÃœLAY_Ã–VGÃœ.length)];
  if(hasYigit) return YÄ°ÄÄ°T_Ã–VGÃœ[Math.floor(Math.random()*YÄ°ÄÄ°T_Ã–VGÃœ.length)];
  // Her mesajda %60 ihtimalle genel Ã¶vgÃ¼ ekle
  if(Math.random() < 0.6) {
    const all = [...TÃœLAY_Ã–VGÃœ, ...YÄ°ÄÄ°T_Ã–VGÃœ, ...Ã‡Ä°FT_Ã–VGÃœ];
    return all[Math.floor(Math.random()*all.length)];
  }
  return null;
}

function botCevapBul(mesaj) {
  const k = mesaj.toLowerCase()
    .replace(/[!?.]/g,'')
    .replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/ÅŸ/g,'s')
    .replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã§/g,'c');

  // En iyi eÅŸleÅŸmeyi bul (kaÃ§ kelime uyuÅŸuyor)
  let enIyi = null, enIyiSkor = 0;
  for(const [key, grup] of Object.entries(BOT_DATA)) {
    const skor = grup.keys.filter(w => {
      const nw = w.replace(/ÄŸ/g,'g').replace(/Ã¼/g,'u').replace(/ÅŸ/g,'s')
        .replace(/Ä±/g,'i').replace(/Ã¶/g,'o').replace(/Ã§/g,'c');
      return k.includes(nw);
    }).length;
    if(skor > enIyiSkor) { enIyiSkor = skor; enIyi = grup; }
  }
  let cevap = '';
  if(enIyi && enIyiSkor > 0) {
    cevap = enIyi.cevap[Math.floor(Math.random() * enIyi.cevap.length)];
  } else {
    cevap = VARSAYILAN[Math.floor(Math.random() * VARSAYILAN.length)];
  }
  // Ã–vgÃ¼ ekle
  const ovgu = rastgeleÃ–vgÃ¼(mesaj);
  if(ovgu) cevap = cevap + '\n\n' + ovgu;
  return cevap;
}

window.sendAIMessage = function() {
  const input = document.getElementById('ai-input');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';

  const msgs = document.getElementById('ai-chat-msgs');
  msgs.innerHTML += `<div class="ai-msg user">${text}</div>`;

  const typing = document.createElement('div');
  typing.className = 'ai-msg bot';
  typing.innerHTML = '<div class="ai-typing"><span></span><span></span><span></span></div>';
  msgs.appendChild(typing);
  msgs.scrollTop = msgs.scrollHeight;

  const gecikme = 700 + Math.random() * 800;
  setTimeout(() => {
    typing.remove();
    const cevap = botCevapBul(text);
    const html = cevap.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
    msgs.innerHTML += `<div class="ai-msg bot">${html}</div>`;
    msgs.scrollTop = msgs.scrollHeight;
  }, gecikme);
}

// ===== MODAL UTILS =====
function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.modal-backdrop').forEach(b=>b.addEventListener('click',e=>{if(e.target===b)b.classList.remove('open');}));

// Initial renders
renderMemCalendar();
renderDrawingShowcase();

// ===== GLOBAL FONKSÄ°YONLAR (onclick iÃ§in) =====
window.showPage = showPage;
window.changeProfilePhoto = changeProfilePhoto;
window.removePhoto = removePhoto;
window.onProfileFileSelected = onProfileFileSelected;
window.loadHoroscope = loadHoroscope;
window.openAlbumModal = openAlbumModal;
window.onAlbumFileSelected = onAlbumFileSelected;
window.saveAlbumPhoto = saveAlbumPhoto;
window.deleteAlbumPhoto = deleteAlbumPhoto;
window.changeMemMonth = changeMemMonth;
window.openMemoryModal = openMemoryModal;
window.onMemoryFileSelected = onMemoryFileSelected;
window.clearMemoryImg = clearMemoryImg;
window.saveMeetupCheck = saveMeetupCheck;
window.saveMemory = saveMemory;
window.deleteMemoryEntry = deleteMemoryEntry;
window.deleteMemoryEntryImg = deleteMemoryEntryImg;
window.changeMoodMonth = changeMoodMonth;
window.selectMood = selectMood;
window.clearMood = clearMood;
window.clearMoodFor = clearMoodFor;
window.deleteDrawing = deleteDrawing;
window.setColor = setColor;
window.setTool = setTool;
window.updateBrush = updateBrush;
window.clearCanvas = clearCanvas;
window.saveCanvasImg = saveCanvasImg;
window.setDreamWho = setDreamWho;
window.addDream = addDream;
window.deleteDream = deleteDream;
window.setLetterTab = setLetterTab;
window.saveLetter = saveLetter;
window.deleteLetter = deleteLetter;
window.playSong = playSong;
window.openModal = openModal;
window.changePlacesMonth = changePlacesMonth;
window.openPlacesDay = openPlacesDay;
window.changePlaceCount = changePlaceCount;
window.addPlaceMap = addPlaceMap;
window.searchMapPlace = searchMapPlace;
window.selectPlace = selectPlace;
window.saveMap = saveMap;
window.deleteMap = deleteMap;
window.renderPlacesCalendar = renderPlacesCalendar;
window.toDateStr = toDateStr;
window.renderPlacesMaps = renderPlacesMaps;
window.addKiss = addKiss;
window.initKissCounter = initKissCounter;
window.closeModal = closeModal;
window.renderDrawingShowcase = renderDrawingShowcase;


// ===== GÄ°DÄ°LEN YERLER =====
let placesMonth = new Date().getMonth(), placesYear = new Date().getFullYear();
let currentPlacesDate = null;

function renderPlacesCalendar() {
  document.getElementById('places-month-label').textContent = new Date(placesYear, placesMonth).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});
  const body = document.getElementById('places-calendar-body');
  body.innerHTML = '';
  const first = new Date(placesYear, placesMonth, 1).getDay();
  const days = new Date(placesYear, placesMonth+1, 0).getDate();
  const prev = new Date(placesYear, placesMonth, 0).getDate();
  const todayStr = toDateStr(new Date());
  for(let i=0;i<first;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=prev-first+i+1;body.appendChild(d);}
  for(let d=1;d<=days;d++){
    const el=document.createElement('div');el.className='cal-day';
    const ds=`${placesYear}-${String(placesMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    if(ds===todayStr) el.classList.add('today');
    if(ds===currentPlacesDate) el.classList.add('selected-draw-day');
    const pd = state.places[ds];
    const count = pd ? (pd.count||0) : 0;
    const maps = pd ? (pd.maps||[]) : [];
    el.innerHTML = `<span class="cal-day-num">${d}</span>` +
      (count > 0 ? `<span style="font-size:0.65rem;display:block;color:var(--rose);">ğŸ“Ã—${count}</span>` : '') +
      (maps.length > 0 ? `<span style="font-size:0.65rem;display:block;color:#d4a853;">ğŸ—ºï¸</span>` : '');
    el.onclick = () => openPlacesDay(ds);
    body.appendChild(el);
  }
  let rem=42-first-days;
  for(let i=1;i<=rem;i++){const d=document.createElement('div');d.className='cal-day other-month';d.textContent=i;body.appendChild(d);}
}

function changePlacesMonth(dir) {
  placesMonth+=dir;
  if(placesMonth>11){placesMonth=0;placesYear++;}
  if(placesMonth<0){placesMonth=11;placesYear--;}
  renderPlacesCalendar();
}

function openPlacesDay(ds) {
  currentPlacesDate = ds;
  renderPlacesCalendar();
  const panel = document.getElementById('places-day-panel');
  panel.style.display='block';
  document.getElementById('places-day-title').textContent =
    'ğŸ“… ' + new Date(ds+'T12:00:00').toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'});
  if(!state.places[ds]) state.places[ds] = { count:0, maps:[] };
  document.getElementById('place-count-num').textContent = state.places[ds].count || 0;
  renderPlacesMaps();
  panel.scrollIntoView({ behavior:'smooth', block:'start' });
}

function changePlaceCount(dir) {
  if(!currentPlacesDate) return;
  if(!state.places[currentPlacesDate]) state.places[currentPlacesDate] = { count:0, maps:[] };
  const cur = state.places[currentPlacesDate].count || 0;
  const next = Math.max(0, cur + dir);
  state.places[currentPlacesDate].count = next;
  document.getElementById('place-count-num').textContent = next;
  saveState();
  renderPlacesCalendar();
}

function addPlaceMap() {
  document.getElementById('map-place-name').value = '';
  document.getElementById('map-search-input').value = '';
  document.getElementById('map-lat').value = '';
  document.getElementById('map-lng').value = '';
  document.getElementById('map-preview-container').style.display='none';
  document.getElementById('map-search-results').style.display='none';
  document.getElementById('map-search-results').innerHTML='';
  openModal('map-modal');
}

async function searchMapPlace() {
  const q = document.getElementById('map-search-input').value.trim();
  if(!q) return;
  const resultsEl = document.getElementById('map-search-results');
  resultsEl.style.display='block';
  resultsEl.innerHTML='<div style="padding:10px;color:var(--text-light);font-size:0.85rem;">ğŸ” AranÄ±yor...</div>';
  try {
    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=5&addressdetails=1`;
    const res = await fetch(url, { headers: {'Accept-Language':'tr'} });
    const data = await res.json();
    if(!data.length) {
      resultsEl.innerHTML='<div style="padding:10px;color:var(--text-light);font-size:0.85rem;">SonuÃ§ bulunamadÄ±. FarklÄ± bir arama deneyin.</div>';
      return;
    }
    resultsEl.innerHTML = data.map((item,i) => `
      <div onclick="selectPlace(${item.lat}, ${item.lon}, '${item.display_name.replace(/'/g,"&#39;").substring(0,60)}...')"
        style="padding:10px 14px;cursor:pointer;border-bottom:1px solid var(--rose-light);font-size:0.83rem;color:var(--text);transition:background 0.15s;"
        onmouseover="this.style.background='rgba(232,105,138,0.12)'" onmouseout="this.style.background=''">
        ğŸ“ ${item.display_name}
      </div>
    `).join('');
  } catch(e) {
    resultsEl.innerHTML='<div style="padding:10px;color:var(--text-light);font-size:0.85rem;">BaÄŸlantÄ± hatasÄ±. Tekrar deneyin.</div>';
  }
}

function selectPlace(lat, lng, displayName) {
  document.getElementById('map-lat').value = lat;
  document.getElementById('map-lng').value = lng;
  document.getElementById('map-search-results').style.display='none';
  if(!document.getElementById('map-place-name').value) {
    document.getElementById('map-place-name').value = displayName;
  }
  const src = `https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.01},${lat-0.01},${lng+0.01},${lat+0.01}&layer=mapnik&marker=${lat},${lng}`;
  document.getElementById('map-preview-iframe').src = src;
  document.getElementById('map-preview-container').style.display='block';
}

function saveMap() {
  const name = document.getElementById('map-place-name').value.trim() || 'Ziyaret edilen yer';
  const lat = parseFloat(document.getElementById('map-lat').value);
  const lng = parseFloat(document.getElementById('map-lng').value);
  if(!lat || !lng) { alert('LÃ¼tfen Ã¶nce bir yer arayÄ±p listeden seÃ§in!'); return; }
  if(!state.places[currentPlacesDate]) state.places[currentPlacesDate] = { count:0, maps:[] };
  if(!state.places[currentPlacesDate].maps) state.places[currentPlacesDate].maps = [];
  state.places[currentPlacesDate].maps.push({ id:Date.now(), name, lat, lng });
  saveState();
  renderPlacesMaps();
  closeModal('map-modal');
}

function renderPlacesMaps() {
  const cont = document.getElementById('places-maps-container');
  const maps = state.places[currentPlacesDate]?.maps || [];
  if(!maps.length) {
    cont.innerHTML = '<div style="text-align:center;color:var(--text-light);padding:20px;font-size:0.88rem;">HenÃ¼z harita eklenmedi.<br>+ Harita Ekle butonuna bas! ğŸ—ºï¸</div>';
    return;
  }
  cont.innerHTML = maps.map(m => `
    <div style="background:var(--card);border-radius:18px;overflow:hidden;border:1px solid var(--rose-light);box-shadow:var(--shadow);">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:12px 16px;">
        <div style="font-family:'Playfair Display',serif;font-size:1rem;color:var(--rose-dark);">ğŸ“ ${m.name}</div>
        <button onclick="deleteMap(${m.id})" style="background:#ffe0e8;border:none;border-radius:8px;padding:4px 10px;cursor:pointer;font-size:0.78rem;color:var(--rose-dark);">âœ• KaldÄ±r</button>
      </div>
      <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${m.lng-0.015},${m.lat-0.015},${m.lng+0.015},${m.lat+0.015}&layer=mapnik&marker=${m.lat},${m.lng}"
        width="100%" height="250" frameborder="0" style="display:block;" loading="lazy"></iframe>
      <div style="padding:10px 16px;font-size:0.75rem;color:var(--text-light);">
        <a href="https://www.openstreetmap.org/?mlat=${m.lat}&mlon=${m.lng}#map=16/${m.lat}/${m.lng}" target="_blank" style="color:var(--rose);text-decoration:none;">ğŸ”— Haritada AÃ§ â†—</a>
      </div>
    </div>
  `).join('');
}

function deleteMap(id) {
  if(!confirm('Bu haritayÄ± kaldÄ±rmak istiyor musun?')) return;
  state.places[currentPlacesDate].maps = state.places[currentPlacesDate].maps.filter(m=>m.id!==id);
  saveState();
  renderPlacesMaps();
}



// ===== Ã–PÃœCÃœK SAYACI =====
function initKissCounter() {
  const today = toDateStr(new Date());
  if (!state.kisses) state.kisses = {};
  
  // Eski gÃ¼nlerin verisini temizle (sadece bugÃ¼nÃ¼nkÃ¼ kalsÄ±n, diÄŸer gÃ¼nler silinsin)
  const keys = Object.keys(state.kisses);
  let changed = false;
  keys.forEach(k => { if(k !== today) { delete state.kisses[k]; changed = true; } });
  if (changed) saveState();

  if (!state.kisses[today]) state.kisses[today] = { tulay: 0, yigit: 0 };

  document.getElementById('kiss-count-tulay').textContent = state.kisses[today].tulay || 0;
  document.getElementById('kiss-count-yigit').textContent = state.kisses[today].yigit || 0;
  
  const label = document.getElementById('kiss-date-label');
  if(label) label.textContent = new Date().toLocaleDateString('tr-TR', {day:'numeric', month:'long', year:'numeric'});
  
  // Gece 24:00 otomatik sÄ±fÄ±rlama
  scheduleKissReset();
}

function scheduleKissReset() {
  const now = new Date();
  const midnight = new Date(now);
  midnight.setHours(24, 0, 0, 0);
  const msToMidnight = midnight - now;
  setTimeout(() => {
    const today = toDateStr(new Date());
    state.kisses = { [today]: { tulay: 0, yigit: 0 } };
    saveState();
    document.getElementById('kiss-count-tulay').textContent = '0';
    document.getElementById('kiss-count-yigit').textContent = '0';
    const label = document.getElementById('kiss-date-label');
    if(label) label.textContent = new Date().toLocaleDateString('tr-TR', {day:'numeric', month:'long', year:'numeric'});
    scheduleKissReset(); // bir sonraki gÃ¼n iÃ§in yeniden planla
  }, msToMidnight);
}

function addKiss(who, btn) {
  const today = toDateStr(new Date());
  if (!state.kisses) state.kisses = {};
  if (!state.kisses[today]) state.kisses[today] = { tulay: 0, yigit: 0 };
  state.kisses[today][who] = (state.kisses[today][who] || 0) + 1;

  // Sadece kiss verisini yaz (tÃ¼m state yerine) â€” Ã§ok daha hÄ±zlÄ±
  set(ref(db, 'state/kisses'), state.kisses).catch(err => console.error(err));
  try { localStorage.setItem('ty-state', JSON.stringify(state)); } catch(e) {}

  const countEl = document.getElementById('kiss-count-' + who);
  countEl.textContent = state.kisses[today][who];
  countEl.classList.remove('bump');
  void countEl.offsetWidth;
  countEl.classList.add('bump');
  setTimeout(() => countEl.classList.remove('bump'), 200);

  // UÃ§uÅŸan Ã¶pÃ¼cÃ¼kler
  const rect = (btn || document.body).getBoundingClientRect();
  const cx = rect.left + rect.width / 2;
  const cy = rect.top + rect.height / 2;
  for (let i = 0; i < 6; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'kiss-fly-emoji';
      el.textContent = ['ğŸ’‹','ğŸ˜˜','ğŸ’•','ğŸ’—','ğŸ’–','ğŸŒ¹'][Math.floor(Math.random()*6)];
      const dx = (Math.random() - 0.5) * 120;
      el.style.cssText = `left:${cx}px;top:${cy}px;--dx:${dx}px;`;
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1000);
    }, i * 80);
  }
}

// ===== YEMEK Ã‡ARKI =====
const WHEEL_COLORS = ['#e8698a','#d4a853','#6a9ae8','#e87a69','#9ae8a0','#c96ae8','#e8c06a','#69c8e8','#e86a9a','#a0e86a'];
let foodItems = [];
let wheelSpinning = false;
let wheelAngle = 0;

function loadFoodItems() {
  try { foodItems = JSON.parse(localStorage.getItem('ty-foods') || '[]'); } catch(e) { foodItems = []; }
  if(!foodItems.length) foodItems = ['Pizza ğŸ•','Burger ğŸ”','Sushi ğŸ£','Makarna ğŸ','DÃ¶ner ğŸ¥™'];
  renderFoodTags();
  drawWheel();
}

function saveFoodItems() {
  try { localStorage.setItem('ty-foods', JSON.stringify(foodItems)); } catch(e) {}
}

window.addFood = function() {
  const input = document.getElementById('food-input');
  const val = input.value.trim();
  if(!val) return;
  foodItems.push(val);
  saveFoodItems();
  input.value = '';
  renderFoodTags();
  drawWheel();
}

window.removeFood = function(i) {
  foodItems.splice(i, 1);
  saveFoodItems();
  renderFoodTags();
  drawWheel();
}

function renderFoodTags() {
  const cont = document.getElementById('food-tags');
  if(!foodItems.length) { cont.innerHTML = '<span style="color:var(--text-light);font-size:0.8rem;">HenÃ¼z yer eklenmedi...</span>'; return; }
  cont.innerHTML = foodItems.map((f,i) => `
    <div style="display:flex;align-items:center;gap:6px;background:white;border:1.5px solid var(--rose-light);border-radius:20px;padding:5px 12px;font-size:0.82rem;color:var(--text);">
      <span>${f}</span>
      <button onclick="removeFood(${i})" style="background:none;border:none;cursor:pointer;color:var(--rose);font-size:0.9rem;line-height:1;padding:0;">âœ•</button>
    </div>
  `).join('');
}

function drawWheel(highlightIndex = -1) {
  const canvas = document.getElementById('wheel-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = canvas.width/2, cy = canvas.height/2, r = cx - 6;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(!foodItems.length) {
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    ctx.fillStyle = '#fce8f0'; ctx.fill();
    ctx.fillStyle = '#7a5c68'; ctx.font = '14px Lato';
    ctx.textAlign = 'center'; ctx.fillText('Yemek ekleyin!', cx, cy);
    return;
  }

  const slice = (Math.PI*2) / foodItems.length;
  foodItems.forEach((item, i) => {
    const start = wheelAngle + i * slice;
    const end = start + slice;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, start, end);
    ctx.closePath();
    ctx.fillStyle = i === highlightIndex ? '#fff176' : WHEEL_COLORS[i % WHEEL_COLORS.length];
    ctx.fill();
    ctx.strokeStyle = 'white'; ctx.lineWidth = 2; ctx.stroke();

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(start + slice/2);
    ctx.textAlign = 'right';
    ctx.fillStyle = 'white';
    ctx.font = `bold ${Math.min(13, 120/foodItems.length + 6)}px Lato`;
    ctx.shadowColor = 'rgba(0,0,0,0.3)'; ctx.shadowBlur = 3;
    const text = item.length > 12 ? item.substring(0,11)+'â€¦' : item;
    ctx.fillText(text, r - 10, 5);
    ctx.restore();
  });

  ctx.beginPath(); ctx.arc(cx,cy,22,0,Math.PI*2);
  ctx.fillStyle = 'white'; ctx.fill();
  ctx.strokeStyle = '#e8698a'; ctx.lineWidth = 3; ctx.stroke();
  ctx.fillStyle = '#e8698a'; ctx.font = 'bold 14px Lato';
  ctx.textAlign = 'center'; ctx.shadowBlur = 0;
  ctx.fillText('ğŸ’•', cx, cy+5);
}

window.spinWheel = function() {
  if(wheelSpinning || !foodItems.length) return;
  wheelSpinning = true;
  document.getElementById('wheel-result').textContent = '';
  document.getElementById('spin-btn').disabled = true;

  const totalRotation = (Math.PI*2) * (8 + Math.random()*8);
  const duration = 3500 + Math.random()*1000;
  const startAngle = wheelAngle;
  const startTime = performance.now();

  function animate(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed/duration, 1);
    const ease = 1 - Math.pow(1-progress, 3);
    wheelAngle = startAngle + totalRotation * ease;
    drawWheel();
    if(progress < 1) {
      requestAnimationFrame(animate);
    } else {
      wheelSpinning = false;
      document.getElementById('spin-btn').disabled = false;
      const slice = (Math.PI*2) / foodItems.length;
      // Ok en Ã¼stte (saat 12 yÃ¶nÃ¼ = -Ï€/2), wheelAngle pozitif yÃ¶nde dÃ¶ndÃ¼
      // Hangi dilim okun altÄ±nda: okun aÃ§Ä±sÄ± sabit (-Ï€/2), Ã§ark dÃ¶ndÃ¼
      const normalized = (( -wheelAngle - Math.PI/2 ) % (Math.PI*2) + Math.PI*2) % (Math.PI*2);
      const winIndex = Math.floor(normalized / slice) % foodItems.length;
      drawWheel(winIndex);
      document.getElementById('wheel-result').innerHTML = `ğŸ‰ <strong>${foodItems[winIndex]}</strong> yiyoruz! Afiyet olsun ğŸ˜‹`;
    }
  }
  requestAnimationFrame(animate);
}

loadFoodItems();

// ===== YAZI TURA =====
let coinFlipping = false;

function drawCoin(face, progress) {
  const canvas = document.getElementById('coin-canvas');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  const cx = canvas.width/2, cy = canvas.height/2;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  const scaleX = Math.max(0.05, Math.abs(Math.cos((progress||0) * Math.PI)));
  ctx.save();
  ctx.translate(cx, cy);
  ctx.scale(scaleX, 1);

  const grad = ctx.createRadialGradient(-20,-20,5,0,0,72);
  if(face === 'yazi') {
    grad.addColorStop(0, '#f9d4df'); grad.addColorStop(1, '#e8698a');
  } else {
    grad.addColorStop(0, '#e8d070'); grad.addColorStop(1, '#d4a853');
  }
  ctx.beginPath(); ctx.arc(0,0,70,0,Math.PI*2);
  ctx.fillStyle = grad; ctx.fill();
  ctx.strokeStyle = face==='yazi'?'#c0435f':'#b8902a'; ctx.lineWidth = 4; ctx.stroke();
  ctx.beginPath(); ctx.arc(0,0,56,0,Math.PI*2);
  ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 2; ctx.stroke();
  ctx.font = '44px serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(face==='yazi'?'ğŸ’•':'ğŸ’™', 0, 0);
  ctx.restore();
}

window.flipCoin = function() {
  if(coinFlipping) return;
  coinFlipping = true;
  document.getElementById('coin-result').textContent = '';
  document.getElementById('coin-btn').disabled = true;

  const finalFace = Math.random() < 0.5 ? 'yazi' : 'tura';
  const flips = 6 + Math.floor(Math.random()*4);
  const duration = 2800;
  const startTime = performance.now();

  function animate(now) {
    const elapsed = now - startTime;
    const progress = Math.min(elapsed/duration, 1);
    const ease = 1 - Math.pow(1-progress, 3);
    const totalProgress = ease * flips;
    const currentFlip = totalProgress % 1;
    const flipCount = Math.floor(totalProgress);
    const face = flipCount % 2 === 0 ? 'yazi' : 'tura';
    drawCoin(face, currentFlip);
    if(progress < 1) {
      requestAnimationFrame(animate);
    } else {
      drawCoin(finalFace, 0);
      coinFlipping = false;
      document.getElementById('coin-btn').disabled = false;
      document.getElementById('coin-result').innerHTML = finalFace === 'yazi'
        ? 'ğŸ’• <strong>YAZI!</strong> TÃ¼lay kazandÄ±! ğŸ‰'
        : 'ğŸ’™ <strong>TURA!</strong> YiÄŸit kazandÄ±! ğŸ‰';
    }
  }
  requestAnimationFrame(animate);
}

drawCoin('yazi', 0);

} // end bootApp


// ===== BAÅLAT =====
const loadOverlay = document.createElement('div');
loadOverlay.style.cssText = 'position:fixed;inset:0;background:rgba(255,248,240,0.97);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;';
loadOverlay.innerHTML = '<div style="font-size:3rem;animation:spin 1.2s linear infinite;">ğŸ’</div><div style="font-size:1rem;color:#c0435f;margin-top:14px;font-family:Playfair Display,serif;">YÃ¼kleniyor...</div><style>@keyframes spin{to{transform:rotate(360deg)}}</style>';
document.body.appendChild(loadOverlay);

loadState().finally(() => {
  loadOverlay.style.transition = 'opacity 0.5s';
  loadOverlay.style.opacity = '0';
  setTimeout(() => loadOverlay.remove(), 500);
});
</script>

<!-- ======================== PLACES PAGE ======================== -->
<div class="page" id="page-places">
  <div class="page-title-bar">ğŸ“ Gidilen Yerler</div>
  <p style="font-size:0.88rem;color:var(--text-light);margin-bottom:20px;">Birlikte gittiÄŸiniz tÃ¼m yerler burada! ğŸ—ºï¸</p>
  <div style="font-size:0.8rem;color:var(--text-light);display:flex;gap:16px;flex-wrap:wrap;margin-bottom:14px;">
    <span>ğŸ“ Gidilen yer sayÄ±sÄ±</span>
    <span>ğŸ—ºï¸ Harita eklendi</span>
  </div>

  <div class="memories-header" style="margin-bottom:16px;">
    <div class="cal-nav">
      <button class="cal-nav-btn" onclick="changePlacesMonth(-1)">â€¹</button>
      <div class="cal-month-label" id="places-month-label"></div>
      <button class="cal-nav-btn" onclick="changePlacesMonth(1)">â€º</button>
    </div>
  </div>

  <div class="calendar-grid" style="margin-bottom:20px;">
    <div class="cal-days-header">
      <div class="cal-day-header">Paz</div><div class="cal-day-header">Pzt</div>
      <div class="cal-day-header">Sal</div><div class="cal-day-header">Ã‡ar</div>
      <div class="cal-day-header">Per</div><div class="cal-day-header">Cum</div>
      <div class="cal-day-header">Cmt</div>
    </div>
    <div class="cal-days-body" id="places-calendar-body"></div>
  </div>

  <!-- SeÃ§ili gÃ¼n detay paneli -->
  <div id="places-day-panel" style="display:none;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
      <div class="page-title-bar" style="margin:0;font-size:1.2rem;" id="places-day-title">ğŸ“… GÃ¼n</div>
      <div style="display:flex;align-items:center;gap:12px;">
        <button onclick="addPlaceMap()" class="add-btn">ğŸ—ºï¸ + Harita Ekle</button>
        <div style="display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--rose-light);border-radius:14px;padding:6px 14px;">
          <button onclick="changePlaceCount(-1)" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--rose);font-weight:700;line-height:1;">âˆ’</button>
          <span id="place-count-num" style="font-family:'Playfair Display',serif;font-size:1.3rem;color:var(--rose-dark);min-width:30px;text-align:center;">0</span>
          <button onclick="changePlaceCount(1)" style="background:none;border:none;cursor:pointer;font-size:1.3rem;color:var(--rose);font-weight:700;line-height:1;">+</button>
        </div>
      </div>
    </div>
    <div id="places-maps-container" style="display:flex;flex-direction:column;gap:16px;"></div>
  </div>
</div>

<!-- MAP MODAL -->
<div class="modal-backdrop" id="map-modal">
  <div class="modal" style="max-width:600px;">
    <div class="modal-title">ğŸ—ºï¸ Harita Ekle</div>
    <button class="modal-close" onclick="closeModal('map-modal')">âœ•</button>
    <input type="text" id="map-place-name" placeholder="Yer adÄ± (Ã¶r: TopkapÄ± SarayÄ±) ğŸ“" style="width:100%;border:1.5px solid var(--rose-light);border-radius:12px;padding:10px 14px;font-family:Lato,sans-serif;font-size:0.9rem;margin-bottom:10px;outline:none;background:#fff;color:var(--text);">
    <div style="font-size:0.82rem;color:var(--text-light);margin-bottom:8px;">ğŸ“ Konumu ara ve haritada seÃ§:</div>
    <div style="display:flex;gap:8px;margin-bottom:8px;">
      <input type="text" id="map-search-input" placeholder="Yer ara... (Ã¶r: KadÄ±kÃ¶y, Ä°stanbul)" style="flex:1;border:1.5px solid var(--rose-light);border-radius:12px;padding:10px 14px;font-family:Lato,sans-serif;font-size:0.85rem;outline:none;background:#fff;color:var(--text);" onkeydown="if(event.key==='Enter') searchMapPlace()">
      <button class="add-btn" onclick="searchMapPlace()" style="white-space:nowrap;">ğŸ” Ara</button>
    </div>
    <div id="map-search-results" style="display:none;background:var(--card);border:1px solid var(--rose-light);border-radius:12px;margin-bottom:8px;max-height:160px;overflow-y:auto;"></div>
    <div id="map-preview-container" style="display:none;margin-bottom:12px;border-radius:14px;overflow:hidden;border:2px solid var(--rose-light);">
      <iframe id="map-preview-iframe" width="100%" height="220" frameborder="0" style="display:block;" allowfullscreen loading="lazy"></iframe>
    </div>
    <input type="hidden" id="map-lat">
    <input type="hidden" id="map-lng">
    <button class="modal-save-btn" onclick="saveMap()">ğŸ’¾ Kaydet</button>
  </div>
</div>

</body>
</html>
